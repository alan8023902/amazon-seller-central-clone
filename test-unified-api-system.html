<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»Ÿä¸€APIç³»ç»Ÿæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-online { background-color: #d4edda; border-color: #c3e6cb; }
        .status-offline { background-color: #f8d7da; border-color: #f5c6cb; }
        .status-loading { background-color: #fff3cd; border-color: #ffeaa7; }
        
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        
        .service-info {
            display: flex;
            flex-direction: column;
        }
        
        .service-name {
            font-weight: bold;
            font-size: 16px;
        }
        
        .service-url {
            color: #666;
            font-size: 14px;
        }
        
        .status-indicator {
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .online { background-color: #28a745; color: white; }
        .offline { background-color: #dc3545; color: white; }
        .loading { background-color: #ffc107; color: black; }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ç»Ÿä¸€APIç³»ç»Ÿæµ‹è¯•</h1>
        <p>æµ‹è¯•å‰ç«¯ã€ç®¡ç†åå°å’Œåç«¯APIçš„ç»Ÿä¸€é…ç½®æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
        
        <button onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <button onclick="testPortConfiguration()">æµ‹è¯•ç«¯å£é…ç½®</button>
        <button onclick="testApiEndpoints()">æµ‹è¯•APIç«¯ç‚¹</button>
        <button onclick="testDataSynchronization()">æµ‹è¯•æ•°æ®åŒæ­¥</button>
        
        <div id="testResults"></div>
    </div>

    <script>
        // é…ç½®å¸¸é‡ - åº”è¯¥ä¸ä»£ç ä¸­çš„é…ç½®ä¸€è‡´
        const CONFIG = {
            FRONTEND_PORT: 3000,
            ADMIN_PORT: 3002,
            BACKEND_PORT: 3001,
            BACKEND_API_BASE: 'http://localhost:3001',
            FRONTEND_URL: 'http://localhost:3000',
            ADMIN_URL: 'http://localhost:3002'
        };

        const API_ENDPOINTS = [
            {
                name: 'åº—é“ºåˆ—è¡¨',
                url: `${CONFIG.BACKEND_API_BASE}/api/stores`,
                method: 'GET',
                description: 'è·å–æ‰€æœ‰åº—é“ºæ•°æ®'
            },
            {
                name: 'Dashboardå¿«ç…§ (ç¾å›½åº—)',
                url: `${CONFIG.BACKEND_API_BASE}/api/dashboard/snapshot/store-us-main`,
                method: 'GET',
                description: 'è·å–ç¾å›½åº—é“ºçš„Dashboardæ•°æ®'
            },
            {
                name: 'Communicationsæ•°æ® (ç¾å›½åº—)',
                url: `${CONFIG.BACKEND_API_BASE}/api/communications/store-us-main`,
                method: 'GET',
                description: 'è·å–ç¾å›½åº—é“ºçš„Communicationsæ•°æ®'
            },
            {
                name: 'äº§å“åˆ—è¡¨ (ç¾å›½åº—)',
                url: `${CONFIG.BACKEND_API_BASE}/api/products?store_id=store-us-main&limit=5`,
                method: 'GET',
                description: 'è·å–ç¾å›½åº—é“ºçš„äº§å“æ•°æ®'
            },
            {
                name: 'ç”¨æˆ·åˆ—è¡¨',
                url: `${CONFIG.BACKEND_API_BASE}/api/users`,
                method: 'GET',
                description: 'è·å–ç”¨æˆ·æ•°æ®'
            },
            {
                name: 'VOCæ•°æ® (ç¾å›½åº—)',
                url: `${CONFIG.BACKEND_API_BASE}/api/voc/store-us-main`,
                method: 'GET',
                description: 'è·å–ç¾å›½åº—é“ºçš„VOCæ•°æ®'
            }
        ];

        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('testResults');
            const logEntry = document.createElement('div');
            logEntry.className = `test-section ${type}`;
            logEntry.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            resultsDiv.appendChild(logEntry);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        async function testPortConfiguration() {
            log('ğŸ” å¼€å§‹æµ‹è¯•ç«¯å£é…ç½®...', 'info');
            
            const services = [
                { name: 'å‰ç«¯åº”ç”¨', url: CONFIG.FRONTEND_URL, expectedPort: CONFIG.FRONTEND_PORT },
                { name: 'ç®¡ç†åå°', url: CONFIG.ADMIN_URL, expectedPort: CONFIG.ADMIN_PORT },
                { name: 'åç«¯API', url: CONFIG.BACKEND_API_BASE, expectedPort: CONFIG.BACKEND_PORT }
            ];

            for (const service of services) {
                try {
                    const response = await fetch(service.url, { 
                        method: 'GET',
                        mode: 'no-cors'
                    });
                    log(`âœ… ${service.name} åœ¨ç«¯å£ ${service.expectedPort} ä¸Šæ­£å¸¸è¿è¡Œ`, 'success');
                } catch (error) {
                    log(`âŒ ${service.name} åœ¨ç«¯å£ ${service.expectedPort} ä¸Šæ— æ³•è®¿é—®: ${error.message}`, 'error');
                }
            }
        }

        async function testApiEndpoints() {
            log('ğŸŒ å¼€å§‹æµ‹è¯•APIç«¯ç‚¹...', 'info');
            
            for (const endpoint of API_ENDPOINTS) {
                try {
                    const response = await fetch(endpoint.url, {
                        method: endpoint.method,
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        const dataCount = Array.isArray(data.data) ? data.data.length : 1;
                        log(`âœ… ${endpoint.name}: æˆåŠŸè¿”å› ${dataCount} æ¡æ•°æ®`, 'success');
                        
                        // æ˜¾ç¤ºä¸€äº›æ•°æ®æ ·æœ¬
                        if (Array.isArray(data.data) && data.data.length > 0) {
                            const sample = data.data[0];
                            const keys = Object.keys(sample).slice(0, 3);
                            log(`   ğŸ“Š æ•°æ®æ ·æœ¬: ${keys.map(key => `${key}: ${sample[key]}`).join(', ')}`, 'info');
                        }
                    } else {
                        log(`âš ï¸ ${endpoint.name}: APIè¿”å›å¤±è´¥ - ${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    }
                } catch (error) {
                    log(`âŒ ${endpoint.name}: è¯·æ±‚å¤±è´¥ - ${error.message}`, 'error');
                }
            }
        }

        async function testDataSynchronization() {
            log('ğŸ”„ å¼€å§‹æµ‹è¯•æ•°æ®åŒæ­¥...', 'info');
            
            try {
                // æµ‹è¯•åº—é“ºæ•°æ®
                const storesResponse = await fetch(`${CONFIG.BACKEND_API_BASE}/api/stores`);
                const storesData = await storesResponse.json();
                
                if (storesData.success && storesData.data.length > 0) {
                    log(`âœ… åº—é“ºæ•°æ®åŒæ­¥æ­£å¸¸: æ‰¾åˆ° ${storesData.data.length} ä¸ªåº—é“º`, 'success');
                    
                    // æµ‹è¯•æ¯ä¸ªåº—é“ºçš„æ•°æ®
                    for (const store of storesData.data.slice(0, 2)) { // åªæµ‹è¯•å‰2ä¸ªåº—é“º
                        log(`ğŸª æµ‹è¯•åº—é“º: ${store.name} (${store.marketplace})`, 'info');
                        
                        // æµ‹è¯•Dashboardæ•°æ®
                        try {
                            const dashboardResponse = await fetch(`${CONFIG.BACKEND_API_BASE}/api/dashboard/snapshot/${store.id}`);
                            const dashboardData = await dashboardResponse.json();
                            
                            if (dashboardData.success) {
                                log(`   âœ… Dashboardæ•°æ®æ­£å¸¸`, 'success');
                            } else {
                                log(`   âš ï¸ Dashboardæ•°æ®å¼‚å¸¸`, 'error');
                            }
                        } catch (error) {
                            log(`   âŒ Dashboardæ•°æ®è·å–å¤±è´¥: ${error.message}`, 'error');
                        }
                        
                        // æµ‹è¯•äº§å“æ•°æ®
                        try {
                            const productsResponse = await fetch(`${CONFIG.BACKEND_API_BASE}/api/products?store_id=${store.id}&limit=3`);
                            const productsData = await productsResponse.json();
                            
                            if (productsData.success) {
                                log(`   âœ… äº§å“æ•°æ®æ­£å¸¸: ${productsData.data.length} ä¸ªäº§å“`, 'success');
                            } else {
                                log(`   âš ï¸ äº§å“æ•°æ®å¼‚å¸¸`, 'error');
                            }
                        } catch (error) {
                            log(`   âŒ äº§å“æ•°æ®è·å–å¤±è´¥: ${error.message}`, 'error');
                        }
                    }
                } else {
                    log(`âŒ åº—é“ºæ•°æ®åŒæ­¥å¤±è´¥`, 'error');
                }
            } catch (error) {
                log(`âŒ æ•°æ®åŒæ­¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testUnifiedConfiguration() {
            log('âš™ï¸ å¼€å§‹æµ‹è¯•ç»Ÿä¸€é…ç½®...', 'info');
            
            // æµ‹è¯•é…ç½®æ˜¯å¦æ­£ç¡®
            const expectedConfig = {
                frontend: 3000,
                admin: 3002,
                backend: 3001
            };
            
            log(`ğŸ“‹ é¢„æœŸé…ç½®: å‰ç«¯=${expectedConfig.frontend}, ç®¡ç†åå°=${expectedConfig.admin}, åç«¯=${expectedConfig.backend}`, 'info');
            
            // éªŒè¯APIåŸºç¡€URLæ˜¯å¦æ­£ç¡®
            if (CONFIG.BACKEND_API_BASE === `http://localhost:${expectedConfig.backend}`) {
                log(`âœ… APIåŸºç¡€URLé…ç½®æ­£ç¡®: ${CONFIG.BACKEND_API_BASE}`, 'success');
            } else {
                log(`âŒ APIåŸºç¡€URLé…ç½®é”™è¯¯: æœŸæœ› http://localhost:${expectedConfig.backend}, å®é™… ${CONFIG.BACKEND_API_BASE}`, 'error');
            }
        }

        async function runAllTests() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '';
            
            log('ğŸš€ å¼€å§‹è¿è¡Œå®Œæ•´çš„APIç³»ç»Ÿæµ‹è¯•...', 'info');
            
            await testUnifiedConfiguration();
            await testPortConfiguration();
            await testApiEndpoints();
            await testDataSynchronization();
            
            log('âœ¨ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼', 'success');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.onload = function() {
            log('ğŸ“± é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡å¼€å§‹æµ‹è¯•...', 'info');
            setTimeout(runAllTests, 1000);
        };
    </script>
</body>
</html>