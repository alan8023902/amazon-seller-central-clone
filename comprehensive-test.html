<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»¼åˆåŠŸèƒ½æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .success { border-left: 4px solid #52c41a; }
        .error { border-left: 4px solid #ff4d4f; }
        .loading { border-left: 4px solid #1890ff; }
        .warning { border-left: 4px solid #faad14; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; background: #1890ff; color: white; }
        button:hover { background: #40a9ff; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .status-success { background: #f6ffed; color: #52c41a; border: 1px solid #b7eb8f; }
        .status-error { background: #fff2f0; color: #ff4d4f; border: 1px solid #ffccc7; }
        .status-loading { background: #e6f7ff; color: #1890ff; border: 1px solid #91d5ff; }
        h1 { color: #262626; text-align: center; margin-bottom: 30px; }
        h3 { color: #595959; margin-top: 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Amazon Seller Central å…‹éš†ç³»ç»Ÿ - ç»¼åˆåŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="grid">
            <!-- 1. åº—é“ºç®¡ç†æµ‹è¯• -->
            <div id="stores-section" class="test-section loading">
                <h3>ğŸª åº—é“ºç®¡ç†æµ‹è¯•</h3>
                <button onclick="testStores()">æµ‹è¯•åº—é“ºAPI</button>
                <div id="stores-result">
                    <span class="status-badge status-loading">ç­‰å¾…æµ‹è¯•</span>
                </div>
            </div>

            <!-- 2. äº§å“ç®¡ç†æµ‹è¯• -->
            <div id="products-section" class="test-section loading">
                <h3>ğŸ“¦ äº§å“ç®¡ç†æµ‹è¯•</h3>
                <button onclick="testProducts()">æµ‹è¯•äº§å“API</button>
                <button onclick="testProductCreate()">æµ‹è¯•äº§å“åˆ›å»º</button>
                <div id="products-result">
                    <span class="status-badge status-loading">ç­‰å¾…æµ‹è¯•</span>
                </div>
            </div>

            <!-- 3. é”€å”®æ•°æ®æµ‹è¯• -->
            <div id="sales-section" class="test-section loading">
                <h3>ğŸ’° é”€å”®æ•°æ®æµ‹è¯•</h3>
                <button onclick="testSalesData()">æµ‹è¯•é”€å”®å¿«ç…§</button>
                <button onclick="testDailySales()">æµ‹è¯•æ—¥é”€å”®æ•°æ®</button>
                <div id="sales-result">
                    <span class="status-badge status-loading">ç­‰å¾…æµ‹è¯•</span>
                </div>
            </div>

            <!-- 4. ä»ªè¡¨æ¿æ•°æ®æµ‹è¯• -->
            <div id="dashboard-section" class="test-section loading">
                <h3>ğŸ“Š ä»ªè¡¨æ¿æ•°æ®æµ‹è¯•</h3>
                <button onclick="testDashboard()">æµ‹è¯•ä»ªè¡¨æ¿API</button>
                <button onclick="testDashboardSnapshot()">æµ‹è¯•ä»ªè¡¨æ¿å¿«ç…§</button>
                <div id="dashboard-result">
                    <span class="status-badge status-loading">ç­‰å¾…æµ‹è¯•</span>
                </div>
            </div>

            <!-- 5. å®¢æˆ·ä¹‹å£°æµ‹è¯• -->
            <div id="voc-section" class="test-section loading">
                <h3>ğŸ—£ï¸ å®¢æˆ·ä¹‹å£°æµ‹è¯•</h3>
                <button onclick="testVocData()">æµ‹è¯•VOCæ•°æ®</button>
                <button onclick="testVocSummary()">æµ‹è¯•VOCæ‘˜è¦</button>
                <div id="voc-result">
                    <span class="status-badge status-loading">ç­‰å¾…æµ‹è¯•</span>
                </div>
            </div>

            <!-- 6. æ•°æ®ä¸€è‡´æ€§æµ‹è¯• -->
            <div id="consistency-section" class="test-section loading">
                <h3>ğŸ”„ æ•°æ®ä¸€è‡´æ€§æµ‹è¯•</h3>
                <button onclick="testDataConsistency()">æµ‹è¯•å‰åç«¯æ•°æ®ä¸€è‡´æ€§</button>
                <div id="consistency-result">
                    <span class="status-badge status-loading">ç­‰å¾…æµ‹è¯•</span>
                </div>
            </div>
        </div>

        <!-- å…¨å±€æµ‹è¯•æ§åˆ¶ -->
        <div class="test-section" style="text-align: center; margin-top: 30px;">
            <button onclick="runAllTests()" style="background: #52c41a; font-size: 16px; padding: 15px 30px;">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <button onclick="clearResults()" style="background: #faad14;">ğŸ§¹ æ¸…é™¤ç»“æœ</button>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3002/api';
        let stores = [];
        let testResults = {};

        // å·¥å…·å‡½æ•°
        function updateSection(sectionId, status, content) {
            const section = document.getElementById(sectionId);
            const result = document.getElementById(sectionId.replace('-section', '-result'));
            
            section.className = `test-section ${status}`;
            
            let statusBadge = '';
            switch(status) {
                case 'success':
                    statusBadge = '<span class="status-badge status-success">âœ… é€šè¿‡</span>';
                    break;
                case 'error':
                    statusBadge = '<span class="status-badge status-error">âŒ å¤±è´¥</span>';
                    break;
                case 'loading':
                    statusBadge = '<span class="status-badge status-loading">â³ æµ‹è¯•ä¸­</span>';
                    break;
                default:
                    statusBadge = '<span class="status-badge status-loading">ç­‰å¾…æµ‹è¯•</span>';
            }
            
            result.innerHTML = statusBadge + '<br>' + content;
        }

        // 1. æµ‹è¯•åº—é“ºç®¡ç†
        async function testStores() {
            updateSection('stores-section', 'loading', 'æ­£åœ¨è·å–åº—é“ºåˆ—è¡¨...');
            
            try {
                const response = await fetch(`${API_BASE}/stores`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    stores = data.data;
                    testResults.stores = true;
                    updateSection('stores-section', 'success', 
                        `æˆåŠŸè·å– ${stores.length} ä¸ªåº—é“º<br>` +
                        `åº—é“ºåˆ—è¡¨: ${stores.map(s => s.name).join(', ')}<br>` +
                        `<pre>${JSON.stringify(data, null, 2)}</pre>`
                    );
                } else {
                    throw new Error('åº—é“ºæ•°æ®æ ¼å¼é”™è¯¯æˆ–ä¸ºç©º');
                }
            } catch (error) {
                testResults.stores = false;
                updateSection('stores-section', 'error', `é”™è¯¯: ${error.message}`);
            }
        }

        // 2. æµ‹è¯•äº§å“ç®¡ç†
        async function testProducts() {
            if (stores.length === 0) {
                updateSection('products-section', 'warning', 'è¯·å…ˆè¿è¡Œåº—é“ºæµ‹è¯•');
                return;
            }

            updateSection('products-section', 'loading', 'æ­£åœ¨è·å–äº§å“åˆ—è¡¨...');
            
            try {
                const storeId = stores[0].id;
                const response = await fetch(`${API_BASE}/products?store_id=${storeId}`);
                const data = await response.json();
                
                if (data.success) {
                    testResults.products = true;
                    updateSection('products-section', 'success', 
                        `æˆåŠŸè·å–åº—é“º "${stores[0].name}" çš„ ${data.data.length} ä¸ªäº§å“<br>` +
                        `<pre>${JSON.stringify(data, null, 2)}</pre>`
                    );
                } else {
                    throw new Error(data.error || 'äº§å“APIè¿”å›é”™è¯¯');
                }
            } catch (error) {
                testResults.products = false;
                updateSection('products-section', 'error', `é”™è¯¯: ${error.message}`);
            }
        }

        // 3. æµ‹è¯•äº§å“åˆ›å»º
        async function testProductCreate() {
            if (stores.length === 0) {
                updateSection('products-section', 'warning', 'è¯·å…ˆè¿è¡Œåº—é“ºæµ‹è¯•');
                return;
            }

            updateSection('products-section', 'loading', 'æ­£åœ¨åˆ›å»ºæµ‹è¯•äº§å“...');
            
            try {
                const storeId = stores[0].id;
                const testProduct = {
                    title: `æµ‹è¯•äº§å“ ${Date.now()}`,
                    store_id: storeId,
                    price: 99.99,
                    sku: `TEST-${Date.now()}`,
                    asin: `B${Date.now().toString().slice(-9)}`,
                    status: 'Active',
                    inventory: 100
                };

                const response = await fetch(`${API_BASE}/products`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testProduct)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    testResults.productCreate = true;
                    updateSection('products-section', 'success', 
                        `æˆåŠŸåˆ›å»ºæµ‹è¯•äº§å“<br>` +
                        `äº§å“ID: ${data.data.id}<br>` +
                        `<pre>${JSON.stringify(data, null, 2)}</pre>`
                    );
                } else {
                    throw new Error(data.error || 'äº§å“åˆ›å»ºå¤±è´¥');
                }
            } catch (error) {
                testResults.productCreate = false;
                updateSection('products-section', 'error', `é”™è¯¯: ${error.message}`);
            }
        }

        // 4. æµ‹è¯•é”€å”®æ•°æ®
        async function testSalesData() {
            if (stores.length === 0) {
                updateSection('sales-section', 'warning', 'è¯·å…ˆè¿è¡Œåº—é“ºæµ‹è¯•');
                return;
            }

            updateSection('sales-section', 'loading', 'æ­£åœ¨è·å–é”€å”®å¿«ç…§...');
            
            try {
                const storeId = stores[0].id;
                const response = await fetch(`${API_BASE}/sales/snapshot/${storeId}`);
                const data = await response.json();
                
                if (data.success) {
                    testResults.sales = true;
                    updateSection('sales-section', 'success', 
                        `æˆåŠŸè·å–é”€å”®å¿«ç…§<br>` +
                        `æ€»è®¢å•é¡¹: ${data.data.total_order_items}<br>` +
                        `è®¢å•äº§å“é”€å”®é¢: $${data.data.ordered_product_sales}<br>` +
                        `<pre>${JSON.stringify(data, null, 2)}</pre>`
                    );
                } else {
                    throw new Error(data.error || 'é”€å”®å¿«ç…§APIè¿”å›é”™è¯¯');
                }
            } catch (error) {
                testResults.sales = false;
                updateSection('sales-section', 'error', `é”™è¯¯: ${error.message}`);
            }
        }

        // 5. æµ‹è¯•æ—¥é”€å”®æ•°æ®
        async function testDailySales() {
            if (stores.length === 0) {
                updateSection('sales-section', 'warning', 'è¯·å…ˆè¿è¡Œåº—é“ºæµ‹è¯•');
                return;
            }

            updateSection('sales-section', 'loading', 'æ­£åœ¨è·å–æ—¥é”€å”®æ•°æ®...');
            
            try {
                const storeId = stores[0].id;
                const response = await fetch(`${API_BASE}/sales/daily/${storeId}`);
                const data = await response.json();
                
                if (data.success) {
                    testResults.dailySales = true;
                    updateSection('sales-section', 'success', 
                        `æˆåŠŸè·å– ${data.data.length} å¤©çš„é”€å”®æ•°æ®<br>` +
                        `<pre>${JSON.stringify(data.data.slice(0, 3), null, 2)}...</pre>`
                    );
                } else {
                    throw new Error(data.error || 'æ—¥é”€å”®æ•°æ®APIè¿”å›é”™è¯¯');
                }
            } catch (error) {
                testResults.dailySales = false;
                updateSection('sales-section', 'error', `é”™è¯¯: ${error.message}`);
            }
        }

        // 6. æµ‹è¯•ä»ªè¡¨æ¿æ•°æ®
        async function testDashboard() {
            if (stores.length === 0) {
                updateSection('dashboard-section', 'warning', 'è¯·å…ˆè¿è¡Œåº—é“ºæµ‹è¯•');
                return;
            }

            updateSection('dashboard-section', 'loading', 'æ­£åœ¨è·å–ä»ªè¡¨æ¿æ•°æ®...');
            
            try {
                const storeId = stores[0].id;
                const response = await fetch(`${API_BASE}/dashboard/${storeId}`);
                const data = await response.json();
                
                if (data.success) {
                    testResults.dashboard = true;
                    updateSection('dashboard-section', 'success', 
                        `æˆåŠŸè·å–ä»ªè¡¨æ¿æ•°æ®<br>` +
                        `ä»Šæ—¥é”€å”®: $${data.data.salesToday}<br>` +
                        `å¾…å¤„ç†è®¢å•: ${data.data.openOrders}<br>` +
                        `åº“å­˜å•†å“: ${data.data.inventory.length}<br>` +
                        `<pre>${JSON.stringify(data.data, null, 2)}</pre>`
                    );
                } else {
                    throw new Error(data.error || 'ä»ªè¡¨æ¿APIè¿”å›é”™è¯¯');
                }
            } catch (error) {
                testResults.dashboard = false;
                updateSection('dashboard-section', 'error', `é”™è¯¯: ${error.message}`);
            }
        }

        // 7. æµ‹è¯•ä»ªè¡¨æ¿å¿«ç…§
        async function testDashboardSnapshot() {
            if (stores.length === 0) {
                updateSection('dashboard-section', 'warning', 'è¯·å…ˆè¿è¡Œåº—é“ºæµ‹è¯•');
                return;
            }

            updateSection('dashboard-section', 'loading', 'æ­£åœ¨è·å–ä»ªè¡¨æ¿å¿«ç…§...');
            
            try {
                const storeId = stores[0].id;
                const response = await fetch(`${API_BASE}/dashboard/snapshot/${storeId}`);
                const data = await response.json();
                
                if (data.success) {
                    testResults.dashboardSnapshot = true;
                    updateSection('dashboard-section', 'success', 
                        `æˆåŠŸè·å–ä»ªè¡¨æ¿å¿«ç…§<br>` +
                        `æ€»äº§å“æ•°: ${data.data.total_products}<br>` +
                        `æ´»è·ƒäº§å“æ•°: ${data.data.active_products}<br>` +
                        `æ€»é”€å”®é¢: $${data.data.total_sales}<br>` +
                        `<pre>${JSON.stringify(data, null, 2)}</pre>`
                    );
                } else {
                    throw new Error(data.error || 'ä»ªè¡¨æ¿å¿«ç…§APIè¿”å›é”™è¯¯');
                }
            } catch (error) {
                testResults.dashboardSnapshot = false;
                updateSection('dashboard-section', 'error', `é”™è¯¯: ${error.message}`);
            }
        }

        // 8. æµ‹è¯•VOCæ•°æ®
        async function testVocData() {
            if (stores.length === 0) {
                updateSection('voc-section', 'warning', 'è¯·å…ˆè¿è¡Œåº—é“ºæµ‹è¯•');
                return;
            }

            updateSection('voc-section', 'loading', 'æ­£åœ¨è·å–VOCæ•°æ®...');
            
            try {
                const storeId = stores[0].id;
                const response = await fetch(`${API_BASE}/voc/data/${storeId}`);
                const data = await response.json();
                
                if (data.success) {
                    testResults.voc = true;
                    updateSection('voc-section', 'success', 
                        `æˆåŠŸè·å– ${data.data.length} æ¡VOCæ•°æ®<br>` +
                        `<pre>${JSON.stringify(data.data.slice(0, 2), null, 2)}...</pre>`
                    );
                } else {
                    throw new Error(data.error || 'VOCæ•°æ®APIè¿”å›é”™è¯¯');
                }
            } catch (error) {
                testResults.voc = false;
                updateSection('voc-section', 'error', `é”™è¯¯: ${error.message}`);
            }
        }

        // 9. æµ‹è¯•VOCæ‘˜è¦
        async function testVocSummary() {
            if (stores.length === 0) {
                updateSection('voc-section', 'warning', 'è¯·å…ˆè¿è¡Œåº—é“ºæµ‹è¯•');
                return;
            }

            updateSection('voc-section', 'loading', 'æ­£åœ¨è·å–VOCæ‘˜è¦...');
            
            try {
                const storeId = stores[0].id;
                const response = await fetch(`${API_BASE}/voc/summary/${storeId}`);
                const data = await response.json();
                
                if (data.success) {
                    testResults.vocSummary = true;
                    const summary = data.data;
                    updateSection('voc-section', 'success', 
                        `æˆåŠŸè·å–VOCæ‘˜è¦<br>` +
                        `ä¼˜ç§€: ${summary.Excellent}, è‰¯å¥½: ${summary.Good}, ä¸€èˆ¬: ${summary.Average}<br>` +
                        `<pre>${JSON.stringify(data, null, 2)}</pre>`
                    );
                } else {
                    throw new Error(data.error || 'VOCæ‘˜è¦APIè¿”å›é”™è¯¯');
                }
            } catch (error) {
                testResults.vocSummary = false;
                updateSection('voc-section', 'error', `é”™è¯¯: ${error.message}`);
            }
        }

        // 10. æµ‹è¯•æ•°æ®ä¸€è‡´æ€§
        async function testDataConsistency() {
            updateSection('consistency-section', 'loading', 'æ­£åœ¨æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§...');
            
            try {
                // æ£€æŸ¥æ‰€æœ‰APIæ˜¯å¦è¿”å›ç›¸åŒåº—é“ºçš„æ•°æ®
                if (stores.length === 0) {
                    throw new Error('è¯·å…ˆè¿è¡Œåº—é“ºæµ‹è¯•');
                }

                const storeId = stores[0].id;
                const [dashboardRes, salesRes, productsRes] = await Promise.all([
                    fetch(`${API_BASE}/dashboard/${storeId}`),
                    fetch(`${API_BASE}/sales/snapshot/${storeId}`),
                    fetch(`${API_BASE}/products?store_id=${storeId}`)
                ]);

                const [dashboardData, salesData, productsData] = await Promise.all([
                    dashboardRes.json(),
                    salesRes.json(),
                    productsRes.json()
                ]);

                let consistencyIssues = [];

                // æ£€æŸ¥äº§å“æ•°é‡ä¸€è‡´æ€§
                if (dashboardData.success && productsData.success) {
                    const dashboardProductCount = dashboardData.data.inventory.length;
                    const actualProductCount = productsData.data.length;
                    
                    if (dashboardProductCount !== actualProductCount) {
                        consistencyIssues.push(`äº§å“æ•°é‡ä¸ä¸€è‡´: ä»ªè¡¨æ¿æ˜¾ç¤º${dashboardProductCount}ä¸ªï¼Œå®é™…æœ‰${actualProductCount}ä¸ª`);
                    }
                }

                // æ£€æŸ¥é”€å”®æ•°æ®ä¸€è‡´æ€§
                if (dashboardData.success && salesData.success) {
                    const dashboardSales = dashboardData.data.salesSnapshot.orderedProductSales;
                    const actualSales = salesData.data.ordered_product_sales;
                    
                    if (Math.abs(dashboardSales - actualSales) > 0.01) {
                        consistencyIssues.push(`é”€å”®é¢ä¸ä¸€è‡´: ä»ªè¡¨æ¿æ˜¾ç¤º$${dashboardSales}ï¼Œå¿«ç…§æ˜¾ç¤º$${actualSales}`);
                    }
                }

                if (consistencyIssues.length === 0) {
                    testResults.consistency = true;
                    updateSection('consistency-section', 'success', 
                        `æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡ âœ…<br>` +
                        `æ‰€æœ‰APIè¿”å›çš„æ•°æ®ä¿æŒä¸€è‡´<br>` +
                        `åº—é“ºID: ${storeId}<br>` +
                        `æ£€æŸ¥é¡¹ç›®: äº§å“æ•°é‡ã€é”€å”®æ•°æ®`
                    );
                } else {
                    testResults.consistency = false;
                    updateSection('consistency-section', 'error', 
                        `å‘ç°æ•°æ®ä¸€è‡´æ€§é—®é¢˜:<br>` +
                        consistencyIssues.map(issue => `â€¢ ${issue}`).join('<br>')
                    );
                }
            } catch (error) {
                testResults.consistency = false;
                updateSection('consistency-section', 'error', `é”™è¯¯: ${error.message}`);
            }
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            console.log('ğŸš€ å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...');
            
            await testStores();
            if (testResults.stores) {
                await testProducts();
                await testProductCreate();
                await testSalesData();
                await testDailySales();
                await testDashboard();
                await testDashboardSnapshot();
                await testVocData();
                await testVocSummary();
                await testDataConsistency();
            }
            
            // æ˜¾ç¤ºæ€»ç»“
            const totalTests = Object.keys(testResults).length;
            const passedTests = Object.values(testResults).filter(Boolean).length;
            
            alert(`æµ‹è¯•å®Œæˆï¼\né€šè¿‡: ${passedTests}/${totalTests}\n${passedTests === totalTests ? 'ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼' : 'âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¯¦æƒ…'}`);
        }

        // æ¸…é™¤ç»“æœ
        function clearResults() {
            testResults = {};
            const sections = ['stores', 'products', 'sales', 'dashboard', 'voc', 'consistency'];
            sections.forEach(section => {
                updateSection(`${section}-section`, 'loading', '<span class="status-badge status-loading">ç­‰å¾…æµ‹è¯•</span>');
            });
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
        window.onload = () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡è¿è¡Œæµ‹è¯•...');
            setTimeout(() => {
                testStores();
            }, 1000);
        };
    </script>
</body>
</html>