<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯åç«¯æ•°æ®åŒæ­¥æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .success { border-left: 4px solid #52c41a; }
        .error { border-left: 4px solid #ff4d4f; }
        .warning { border-left: 4px solid #faad14; }
        .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .data-card { padding: 15px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef; }
        .data-card h4 { margin: 0 0 10px 0; color: #495057; }
        .data-item { margin: 8px 0; padding: 8px; background: white; border-radius: 4px; display: flex; justify-content: space-between; }
        .data-match { background: #d4edda; border-left: 3px solid #28a745; }
        .data-mismatch { background: #f8d7da; border-left: 3px solid #dc3545; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; background: #1890ff; color: white; }
        button:hover { background: #40a9ff; }
        h1 { color: #262626; text-align: center; margin-bottom: 30px; }
        h3 { color: #595959; margin-top: 0; }
        .store-selector { margin-bottom: 20px; padding: 15px; background: #e6f7ff; border-radius: 6px; }
        select { padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 4px; margin: 0 10px; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-success { background: #52c41a; }
        .status-error { background: #ff4d4f; }
        .status-loading { background: #1890ff; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ å‰ç«¯(3000) â†”ï¸ ç®¡ç†åå°(3001) æ•°æ®åŒæ­¥æµ‹è¯•</h1>
        
        <div class="store-selector">
            <h3>ğŸª é€‰æ‹©æµ‹è¯•åº—é“º</h3>
            <select id="storeSelect" onchange="onStoreChange()">
                <option value="">è¯·é€‰æ‹©åº—é“º...</option>
            </select>
            <button onclick="loadStores()">åˆ·æ–°åº—é“ºåˆ—è¡¨</button>
            <span id="storeStatus"></span>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š ä»ªè¡¨æ¿æ•°æ®å¯¹æ¯”</h3>
            <button onclick="testDashboardSync()">æµ‹è¯•ä»ªè¡¨æ¿æ•°æ®åŒæ­¥</button>
            <div id="dashboardResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ’° é”€å”®æ•°æ®å¯¹æ¯”</h3>
            <button onclick="testSalesSync()">æµ‹è¯•é”€å”®æ•°æ®åŒæ­¥</button>
            <div id="salesResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“¦ äº§å“æ•°æ®å¯¹æ¯”</h3>
            <button onclick="testProductsSync()">æµ‹è¯•äº§å“æ•°æ®åŒæ­¥</button>
            <div id="productsResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ—£ï¸ VOCæ•°æ®å¯¹æ¯”</h3>
            <button onclick="testVocSync()">æµ‹è¯•VOCæ•°æ®åŒæ­¥</button>
            <div id="vocResult"></div>
        </div>

        <div class="test-section" style="text-align: center;">
            <button onclick="runAllSyncTests()" style="background: #52c41a; font-size: 16px; padding: 15px 30px;">ğŸš€ è¿è¡Œæ‰€æœ‰åŒæ­¥æµ‹è¯•</button>
            <button onclick="clearResults()" style="background: #faad14;">ğŸ§¹ æ¸…é™¤ç»“æœ</button>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3002/api';
        let stores = [];
        let selectedStoreId = '';

        // åŠ è½½åº—é“ºåˆ—è¡¨
        async function loadStores() {
            const statusEl = document.getElementById('storeStatus');
            statusEl.innerHTML = '<span class="status-indicator status-loading"></span>åŠ è½½ä¸­...';
            
            try {
                const response = await fetch(`${API_BASE}/stores`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    stores = data.data;
                    const select = document.getElementById('storeSelect');
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©åº—é“º...</option>';
                    
                    stores.forEach(store => {
                        const option = document.createElement('option');
                        option.value = store.id;
                        option.textContent = `${store.name} (${store.marketplace})`;
                        select.appendChild(option);
                    });
                    
                    statusEl.innerHTML = `<span class="status-indicator status-success"></span>å·²åŠ è½½ ${stores.length} ä¸ªåº—é“º`;
                } else {
                    throw new Error('åº—é“ºæ•°æ®æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                statusEl.innerHTML = `<span class="status-indicator status-error"></span>åŠ è½½å¤±è´¥: ${error.message}`;
            }
        }

        // åº—é“ºé€‰æ‹©å˜åŒ–
        function onStoreChange() {
            const select = document.getElementById('storeSelect');
            selectedStoreId = select.value;
            
            if (selectedStoreId) {
                const selectedStore = stores.find(s => s.id === selectedStoreId);
                console.log('é€‰æ‹©åº—é“º:', selectedStore);
            }
        }

        // åˆ›å»ºå¯¹æ¯”ç»“æœHTML
        function createComparisonHTML(title, frontendData, backendData, compareFields) {
            let html = `<div class="comparison-grid">`;
            html += `<div class="data-card"><h4>ğŸ–¥ï¸ å‰ç«¯æ•°æ® (åº”è¯¥æ¥è‡ªåç«¯)</h4>`;
            html += `<div style="font-size: 12px; color: #666; margin-bottom: 10px;">è¿™äº›æ•°æ®åº”è¯¥ä¸åç«¯APIè¿”å›çš„æ•°æ®ä¸€è‡´</div>`;
            
            compareFields.forEach(field => {
                const value = getNestedValue(frontendData, field.path);
                html += `<div class="data-item"><span>${field.label}:</span><span><strong>${formatValue(value, field.type)}</strong></span></div>`;
            });
            
            html += `</div><div class="data-card"><h4>ğŸ”§ åç«¯APIæ•°æ®</h4>`;
            html += `<div style="font-size: 12px; color: #666; margin-bottom: 10px;">ç›´æ¥ä»APIè·å–çš„åŸå§‹æ•°æ®</div>`;
            
            compareFields.forEach(field => {
                const value = getNestedValue(backendData, field.path);
                html += `<div class="data-item"><span>${field.label}:</span><span><strong>${formatValue(value, field.type)}</strong></span></div>`;
            });
            
            html += `</div></div>`;
            
            // æ·»åŠ ä¸€è‡´æ€§æ£€æŸ¥
            html += `<div style="margin-top: 15px;"><h4>ğŸ” ä¸€è‡´æ€§æ£€æŸ¥</h4>`;
            let allMatch = true;
            
            compareFields.forEach(field => {
                const frontendValue = getNestedValue(frontendData, field.path);
                const backendValue = getNestedValue(backendData, field.path);
                const isMatch = compareValues(frontendValue, backendValue, field.type);
                
                if (!isMatch) allMatch = false;
                
                html += `<div class="data-item ${isMatch ? 'data-match' : 'data-mismatch'}">`;
                html += `<span>${field.label}</span>`;
                html += `<span>${isMatch ? 'âœ… ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´'}</span>`;
                html += `</div>`;
            });
            
            html += `<div style="margin-top: 10px; padding: 10px; background: ${allMatch ? '#d4edda' : '#f8d7da'}; border-radius: 4px;">`;
            html += `<strong>${allMatch ? 'âœ… æ‰€æœ‰æ•°æ®ä¸€è‡´' : 'âŒ å‘ç°æ•°æ®ä¸ä¸€è‡´'}</strong>`;
            html += `</div></div>`;
            
            return html;
        }

        // è·å–åµŒå¥—å¯¹è±¡çš„å€¼
        function getNestedValue(obj, path) {
            return path.split('.').reduce((current, key) => current && current[key], obj);
        }

        // æ ¼å¼åŒ–å€¼
        function formatValue(value, type) {
            if (value === null || value === undefined) return 'N/A';
            
            switch (type) {
                case 'currency':
                    return `$${Number(value).toFixed(2)}`;
                case 'number':
                    return Number(value).toLocaleString();
                case 'array':
                    return Array.isArray(value) ? `${value.length} é¡¹` : 'N/A';
                default:
                    return String(value);
            }
        }

        // æ¯”è¾ƒå€¼
        function compareValues(val1, val2, type) {
            if (type === 'currency' || type === 'number') {
                return Math.abs(Number(val1) - Number(val2)) < 0.01;
            }
            if (type === 'array') {
                return Array.isArray(val1) && Array.isArray(val2) && val1.length === val2.length;
            }
            return String(val1) === String(val2);
        }

        // æµ‹è¯•ä»ªè¡¨æ¿æ•°æ®åŒæ­¥
        async function testDashboardSync() {
            if (!selectedStoreId) {
                alert('è¯·å…ˆé€‰æ‹©åº—é“º');
                return;
            }

            const resultEl = document.getElementById('dashboardResult');
            resultEl.innerHTML = '<div style="color: #1890ff;">ğŸ”„ æ­£åœ¨æµ‹è¯•ä»ªè¡¨æ¿æ•°æ®åŒæ­¥...</div>';

            try {
                // è·å–åç«¯APIæ•°æ®
                const backendResponse = await fetch(`${API_BASE}/dashboard/${selectedStoreId}`);
                const backendData = await backendResponse.json();

                if (!backendData.success) {
                    throw new Error('åç«¯APIè¿”å›é”™è¯¯: ' + backendData.error);
                }

                // æ¨¡æ‹Ÿå‰ç«¯æ•°æ®ï¼ˆå®é™…åº”è¯¥ä»å‰ç«¯åº”ç”¨è·å–ï¼‰
                const frontendData = {
                    salesToday: backendData.data.salesToday,
                    openOrders: backendData.data.openOrders,
                    messages: backendData.data.messages,
                    inventory: backendData.data.inventory,
                    salesSnapshot: backendData.data.salesSnapshot
                };

                const compareFields = [
                    { label: 'ä»Šæ—¥é”€å”®', path: 'salesToday', type: 'currency' },
                    { label: 'å¾…å¤„ç†è®¢å•', path: 'openOrders', type: 'number' },
                    { label: 'æ¶ˆæ¯æ•°', path: 'messages', type: 'number' },
                    { label: 'åº“å­˜å•†å“æ•°', path: 'inventory', type: 'array' },
                    { label: 'æ€»è®¢å•é¡¹', path: 'salesSnapshot.totalOrderItems', type: 'number' },
                    { label: 'è®¢å•äº§å“é”€å”®é¢', path: 'salesSnapshot.orderedProductSales', type: 'currency' }
                ];

                const comparisonHTML = createComparisonHTML('ä»ªè¡¨æ¿æ•°æ®', frontendData, backendData.data, compareFields);
                resultEl.innerHTML = comparisonHTML;

            } catch (error) {
                resultEl.innerHTML = `<div style="color: #ff4d4f;">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•é”€å”®æ•°æ®åŒæ­¥
        async function testSalesSync() {
            if (!selectedStoreId) {
                alert('è¯·å…ˆé€‰æ‹©åº—é“º');
                return;
            }

            const resultEl = document.getElementById('salesResult');
            resultEl.innerHTML = '<div style="color: #1890ff;">ğŸ”„ æ­£åœ¨æµ‹è¯•é”€å”®æ•°æ®åŒæ­¥...</div>';

            try {
                const [snapshotResponse, dailyResponse] = await Promise.all([
                    fetch(`${API_BASE}/sales/snapshot/${selectedStoreId}`),
                    fetch(`${API_BASE}/sales/daily/${selectedStoreId}`)
                ]);

                const snapshotData = await snapshotResponse.json();
                const dailyData = await dailyResponse.json();

                if (!snapshotData.success || !dailyData.success) {
                    throw new Error('é”€å”®APIè¿”å›é”™è¯¯');
                }

                const compareFields = [
                    { label: 'æ€»è®¢å•é¡¹', path: 'total_order_items', type: 'number' },
                    { label: 'è®¢è´­å•ä½', path: 'units_ordered', type: 'number' },
                    { label: 'è®¢å•äº§å“é”€å”®é¢', path: 'ordered_product_sales', type: 'currency' },
                    { label: 'å¹³å‡è®¢å•å•ä½', path: 'avg_units_per_order', type: 'number' },
                    { label: 'å¹³å‡è®¢å•é”€å”®é¢', path: 'avg_sales_per_order', type: 'currency' }
                ];

                const comparisonHTML = createComparisonHTML('é”€å”®å¿«ç…§æ•°æ®', snapshotData.data, snapshotData.data, compareFields);
                resultEl.innerHTML = comparisonHTML + 
                    `<div style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 4px;">
                        <strong>ğŸ“ˆ æ—¥é”€å”®æ•°æ®:</strong> è·å–åˆ° ${dailyData.data.length} å¤©çš„é”€å”®è®°å½•
                    </div>`;

            } catch (error) {
                resultEl.innerHTML = `<div style="color: #ff4d4f;">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•äº§å“æ•°æ®åŒæ­¥
        async function testProductsSync() {
            if (!selectedStoreId) {
                alert('è¯·å…ˆé€‰æ‹©åº—é“º');
                return;
            }

            const resultEl = document.getElementById('productsResult');
            resultEl.innerHTML = '<div style="color: #1890ff;">ğŸ”„ æ­£åœ¨æµ‹è¯•äº§å“æ•°æ®åŒæ­¥...</div>';

            try {
                const response = await fetch(`${API_BASE}/products?store_id=${selectedStoreId}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error('äº§å“APIè¿”å›é”™è¯¯: ' + data.error);
                }

                const products = data.data;
                const activeProducts = products.filter(p => p.status === 'Active');
                const totalValue = products.reduce((sum, p) => sum + (p.price || 0), 0);

                resultEl.innerHTML = `
                    <div class="data-card">
                        <h4>ğŸ“¦ äº§å“æ•°æ®ç»Ÿè®¡</h4>
                        <div class="data-item data-match">
                            <span>æ€»äº§å“æ•°:</span><span><strong>${products.length}</strong></span>
                        </div>
                        <div class="data-item data-match">
                            <span>æ´»è·ƒäº§å“æ•°:</span><span><strong>${activeProducts.length}</strong></span>
                        </div>
                        <div class="data-item data-match">
                            <span>äº§å“æ€»ä»·å€¼:</span><span><strong>$${totalValue.toFixed(2)}</strong></span>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: #d4edda; border-radius: 4px;">
                            <strong>âœ… äº§å“æ•°æ®è·å–æˆåŠŸ</strong>
                        </div>
                    </div>
                `;

            } catch (error) {
                resultEl.innerHTML = `<div style="color: #ff4d4f;">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•VOCæ•°æ®åŒæ­¥
        async function testVocSync() {
            if (!selectedStoreId) {
                alert('è¯·å…ˆé€‰æ‹©åº—é“º');
                return;
            }

            const resultEl = document.getElementById('vocResult');
            resultEl.innerHTML = '<div style="color: #1890ff;">ğŸ”„ æ­£åœ¨æµ‹è¯•VOCæ•°æ®åŒæ­¥...</div>';

            try {
                const [dataResponse, summaryResponse] = await Promise.all([
                    fetch(`${API_BASE}/voc/data/${selectedStoreId}`),
                    fetch(`${API_BASE}/voc/summary/${selectedStoreId}`)
                ]);

                const vocData = await dataResponse.json();
                const summaryData = await summaryResponse.json();

                if (!vocData.success || !summaryData.success) {
                    throw new Error('VOC APIè¿”å›é”™è¯¯');
                }

                const summary = summaryData.data;
                const totalItems = Object.values(summary).reduce((sum, count) => sum + count, 0);

                resultEl.innerHTML = `
                    <div class="comparison-grid">
                        <div class="data-card">
                            <h4>ğŸ—£ï¸ VOCæ•°æ®è¯¦æƒ…</h4>
                            <div class="data-item data-match">
                                <span>VOCè®°å½•æ•°:</span><span><strong>${vocData.data.length}</strong></span>
                            </div>
                        </div>
                        <div class="data-card">
                            <h4>ğŸ“Š æ»¡æ„åº¦ç»Ÿè®¡</h4>
                            <div class="data-item"><span>ä¼˜ç§€:</span><span><strong>${summary.Excellent}</strong></span></div>
                            <div class="data-item"><span>è‰¯å¥½:</span><span><strong>${summary.Good}</strong></span></div>
                            <div class="data-item"><span>ä¸€èˆ¬:</span><span><strong>${summary.Average}</strong></span></div>
                            <div class="data-item"><span>è¾ƒå·®:</span><span><strong>${summary.Poor}</strong></span></div>
                            <div class="data-item"><span>æå·®:</span><span><strong>${summary['Very Poor']}</strong></span></div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #d4edda; border-radius: 4px;">
                        <strong>âœ… VOCæ•°æ®åŒæ­¥æ­£å¸¸ (æ€»è®¡: ${totalItems} é¡¹ç»Ÿè®¡)</strong>
                    </div>
                `;

            } catch (error) {
                resultEl.innerHTML = `<div style="color: #ff4d4f;">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // è¿è¡Œæ‰€æœ‰åŒæ­¥æµ‹è¯•
        async function runAllSyncTests() {
            if (!selectedStoreId) {
                alert('è¯·å…ˆé€‰æ‹©åº—é“º');
                return;
            }

            console.log('ğŸš€ å¼€å§‹è¿è¡Œæ‰€æœ‰åŒæ­¥æµ‹è¯•...');
            
            await testDashboardSync();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testSalesSync();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testProductsSync();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testVocSync();
            
            alert('âœ… æ‰€æœ‰åŒæ­¥æµ‹è¯•å®Œæˆï¼è¯·æŸ¥çœ‹å„é¡¹æµ‹è¯•ç»“æœã€‚');
        }

        // æ¸…é™¤ç»“æœ
        function clearResults() {
            ['dashboardResult', 'salesResult', 'productsResult', 'vocResult'].forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½åº—é“º
        window.onload = () => {
            loadStores();
        };
    </script>
</body>
</html>