import express from 'express';
import { dataService } from '../services/dataService';
import { 
  GlobalSnapshotSchema, 
  type GlobalSnapshot, 
  type Product,
  type ForumPost,
  type ApiResponse 
} from '../types/index';
import { asyncHandler, createError } from '../middleware/errorHandler';

const router = express.Router();

// GET /api/dashboard/snapshot/:storeId - Get global snapshot data
router.get('/snapshot/:storeId', asyncHandler(async (req, res) => {
  const { storeId } = req.params;
  
  let snapshots = await dataService.findByStoreId<GlobalSnapshot>('global_snapshots', storeId);
  let snapshot = snapshots[0];
  
  // Create default snapshot if none exists
  if (!snapshot) {
    snapshot = await dataService.create<GlobalSnapshot>('global_snapshots', {
      store_id: storeId,
      sales_amount: 49.95,
      open_orders: 6,
      buyer_messages: 0,
      featured_offer_percent: 100,
      seller_feedback_rating: 5.00,
      seller_feedback_count: 2,
      payments_balance: 228.31,
      fbm_unshipped: 0,
      fbm_pending: 0,
      fba_pending: 6,
      inventory_performance_index: 400,
      ad_sales: 0,
      ad_impressions: 0,
      updated_at: new Date().toISOString(),
    });
  }
  
  const response: ApiResponse<GlobalSnapshot> = {
    success: true,
    data: snapshot,
  };
  
  res.json(response);
}));

// PUT /api/dashboard/snapshot/:storeId - Update global snapshot
router.put('/snapshot/:storeId', asyncHandler(async (req, res) => {
  const { storeId } = req.params;
  
  const updateData = GlobalSnapshotSchema.partial().parse({
    ...req.body,
    updated_at: new Date().toISOString(),
  });
  
  let snapshots = await dataService.findByStoreId<GlobalSnapshot>('global_snapshots', storeId);
  let snapshot = snapshots[0];
  
  if (!snapshot) {
    // Create new snapshot
    snapshot = await dataService.create<GlobalSnapshot>('global_snapshots', {
      store_id: storeId,
      ...updateData,
      updated_at: new Date().toISOString(),
    });
  } else {
    // Update existing snapshot
    snapshot = await dataService.update<GlobalSnapshot>('global_snapshots', snapshot.id, updateData);
  }
  
  if (!snapshot) {
    throw createError('Failed to update snapshot', 500);
  }
  
  const response: ApiResponse<GlobalSnapshot> = {
    success: true,
    data: snapshot,
    message: 'Snapshot updated successfully',
  };
  
  res.json(response);
}));

// GET /api/dashboard/products/:storeId - Get product performance data
router.get('/products/:storeId', asyncHandler(async (req, res) => {
  const { storeId } = req.params;
  const { limit = 5 } = req.query;
  
  let products = await dataService.findByStoreId<Product>('products', storeId);
  
  // Sort by sales amount descending and limit results
  products = products
    .sort((a, b) => b.sales_amount - a.sales_amount)
    .slice(0, Number(limit));
  
  const response: ApiResponse<Product[]> = {
    success: true,
    data: products,
  };
  
  res.json(response);
}));

// GET /api/dashboard/actions/:storeId - Get action items
router.get('/actions/:storeId', asyncHandler(async (req, res) => {
  // Mock action items for now
  const actions = [
    { id: "shipmentPerformance", count: null, text: "Review shipment performance" },
    { id: "shipOrders", count: 10, text: "Ship orders" },
    { id: "reviewReturns", count: 2, text: "Review returns" },
    { id: "fixStrandedInventory", count: null, text: "Fix stranded inventory" },
  ];
  
  const response: ApiResponse = {
    success: true,
    data: actions,
  };
  
  res.json(response);
}));

// GET /api/dashboard/communications/:storeId - Get communication items
router.get('/communications/:storeId', asyncHandler(async (req, res) => {
  const { storeId } = req.params;
  
  let forumPosts = await dataService.findByStoreId<ForumPost>('forum_posts', storeId);
  
  // Create default forum posts if none exist
  if (forumPosts.length === 0) {
    const defaultPosts = [
      {
        store_id: storeId,
        title: "New seller performance standards",
        post_date: new Date().toISOString().split('T')[0],
        views: 1234,
        comments: 56,
        post_type: 'FORUM' as const,
        likes: 0,
      },
      {
        store_id: storeId,
        title: "Holiday selling tips and best practices",
        post_date: new Date().toISOString().split('T')[0],
        views: 987,
        comments: 23,
        post_type: 'NEWS' as const,
        likes: 45,
      },
    ];
    
    for (const post of defaultPosts) {
      await dataService.create<ForumPost>('forum_posts', post);
    }
    
    forumPosts = await dataService.findByStoreId<ForumPost>('forum_posts', storeId);
  }
  
  const response: ApiResponse<ForumPost[]> = {
    success: true,
    data: forumPosts,
  };
  
  res.json(response);
}));

// GET /api/dashboard/health/:storeId - Get account health status
router.get('/health/:storeId', asyncHandler(async (req, res) => {
  // Mock health data for now
  const healthData = {
    status: 'Healthy',
    score: 1000,
    criticalIssues: 0,
    recommendations: [
      'Continue maintaining excellent performance',
      'Monitor inventory levels regularly',
    ],
  };
  
  const response: ApiResponse = {
    success: true,
    data: healthData,
  };
  
  res.json(response);
}));

export = router;