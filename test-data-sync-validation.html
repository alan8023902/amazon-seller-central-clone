<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åŒæ­¥éªŒè¯æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { border-color: #4CAF50; background-color: #f1f8e9; }
        .error { border-color: #f44336; background-color: #ffebee; }
        .warning { border-color: #ff9800; background-color: #fff3e0; }
        .info { border-color: #2196F3; background-color: #e3f2fd; }
        
        button {
            background-color: #007185;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #005a6b;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .data-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online { background-color: #4CAF50; }
        .status-offline { background-color: #f44336; }
        .status-loading { background-color: #ff9800; }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .iframe-container {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background-color: #1e1e1e;
            color: #ffffff;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-info { color: #61dafb; }
        .log-success { color: #4CAF50; }
        .log-error { color: #f44336; }
        .log-warning { color: #ff9800; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Amazon Seller Central - æ•°æ®åŒæ­¥éªŒè¯æµ‹è¯•</h1>
        <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•ç®¡ç†åå°(3001)å’Œå‰ç«¯(3000)ä¹‹é—´çš„æ•°æ®åŒæ­¥åŠŸèƒ½</p>
    </div>

    <!-- æœåŠ¡çŠ¶æ€æ£€æŸ¥ -->
    <div class="container">
        <h2>ğŸ” æœåŠ¡çŠ¶æ€æ£€æŸ¥</h2>
        <div class="test-section info">
            <h3>åç«¯æœåŠ¡ (Port 3002)</h3>
            <div id="backend-status">
                <span class="status-indicator status-loading"></span>
                <span>æ£€æŸ¥ä¸­...</span>
            </div>
            <button onclick="checkBackendStatus()">é‡æ–°æ£€æŸ¥</button>
        </div>
        
        <div class="test-section info">
            <h3>å‰ç«¯æœåŠ¡ (Port 3000)</h3>
            <div id="frontend-status">
                <span class="status-indicator status-loading"></span>
                <span>æ£€æŸ¥ä¸­...</span>
            </div>
            <button onclick="checkFrontendStatus()">é‡æ–°æ£€æŸ¥</button>
        </div>
        
        <div class="test-section info">
            <h3>ç®¡ç†åå° (Port 3001)</h3>
            <div id="admin-status">
                <span class="status-indicator status-loading"></span>
                <span>æ£€æŸ¥ä¸­...</span>
            </div>
            <button onclick="checkAdminStatus()">é‡æ–°æ£€æŸ¥</button>
        </div>
    </div>

    <!-- åº—é“ºç®¡ç†æµ‹è¯• -->
    <div class="container">
        <h2>ğŸª åº—é“ºç®¡ç†æµ‹è¯•</h2>
        <div class="test-section">
            <h3>åº—é“ºåˆ—è¡¨</h3>
            <button onclick="loadStores()">åŠ è½½åº—é“ºåˆ—è¡¨</button>
            <button onclick="createTestStore()">åˆ›å»ºæµ‹è¯•åº—é“º</button>
            <div id="stores-data" class="data-display">ç‚¹å‡»"åŠ è½½åº—é“ºåˆ—è¡¨"æŸ¥çœ‹æ•°æ®</div>
        </div>
        
        <div class="test-section">
            <h3>å½“å‰é€‰ä¸­åº—é“º</h3>
            <select id="store-selector" onchange="switchStore()">
                <option value="">é€‰æ‹©åº—é“º...</option>
            </select>
            <div id="current-store-data" class="data-display">è¯·é€‰æ‹©åº—é“º</div>
        </div>
    </div>

    <!-- æ•°æ®åŒæ­¥æµ‹è¯• -->
    <div class="container">
        <h2>ğŸ”„ æ•°æ®åŒæ­¥æµ‹è¯•</h2>
        
        <div class="test-section">
            <h3>Dashboard å…¨å±€å¿«ç…§æ•°æ®</h3>
            <button onclick="loadDashboardData()">åŠ è½½Dashboardæ•°æ®</button>
            <button onclick="updateDashboardData()">æ›´æ–°Dashboardæ•°æ®</button>
            <div id="dashboard-data" class="data-display">ç‚¹å‡»"åŠ è½½Dashboardæ•°æ®"æŸ¥çœ‹</div>
        </div>
        
        <div class="test-section">
            <h3>äº§å“æ•°æ®</h3>
            <button onclick="loadProductsData()">åŠ è½½äº§å“æ•°æ®</button>
            <button onclick="createTestProduct()">åˆ›å»ºæµ‹è¯•äº§å“</button>
            <button onclick="updateTestProduct()">æ›´æ–°æµ‹è¯•äº§å“</button>
            <div id="products-data" class="data-display">ç‚¹å‡»"åŠ è½½äº§å“æ•°æ®"æŸ¥çœ‹</div>
        </div>
        
        <div class="test-section">
            <h3>é”€å”®æ•°æ®</h3>
            <button onclick="loadSalesData()">åŠ è½½é”€å”®æ•°æ®</button>
            <button onclick="updateSalesData()">æ›´æ–°é”€å”®æ•°æ®</button>
            <div id="sales-data" class="data-display">ç‚¹å‡»"åŠ è½½é”€å”®æ•°æ®"æŸ¥çœ‹</div>
        </div>
    </div>

    <!-- ç•Œé¢é¢„è§ˆ -->
    <div class="container">
        <h2>ğŸ–¥ï¸ ç•Œé¢é¢„è§ˆ</h2>
        <div class="grid">
            <div>
                <h3>å‰ç«¯ç•Œé¢ (Port 3000)</h3>
                <div class="iframe-container">
                    <iframe src="http://localhost:3000" title="å‰ç«¯ç•Œé¢"></iframe>
                </div>
                <button onclick="refreshFrontend()">åˆ·æ–°å‰ç«¯</button>
            </div>
            <div>
                <h3>ç®¡ç†åå° (Port 3001)</h3>
                <div class="iframe-container">
                    <iframe src="http://localhost:3001" title="ç®¡ç†åå°"></iframe>
                </div>
                <button onclick="refreshAdmin()">åˆ·æ–°ç®¡ç†åå°</button>
            </div>
        </div>
    </div>

    <!-- æµ‹è¯•æ—¥å¿— -->
    <div class="container">
        <h2>ğŸ“‹ æµ‹è¯•æ—¥å¿—</h2>
        <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        <button onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
        <div id="test-logs" class="log-container">
            <div class="log-entry log-info">æµ‹è¯•ç³»ç»Ÿå·²åˆå§‹åŒ–</div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentStoreId = null;
        let testData = {
            stores: [],
            dashboard: null,
            products: [],
            sales: null
        };

        // æ—¥å¿—åŠŸèƒ½
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('test-logs');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('test-logs').innerHTML = '<div class="log-entry log-info">æ—¥å¿—å·²æ¸…ç©º</div>';
        }

        // æœåŠ¡çŠ¶æ€æ£€æŸ¥
        async function checkBackendStatus() {
            try {
                const response = await fetch('http://localhost:3002/api/health');
                const data = await response.json();
                updateStatus('backend-status', true, `åç«¯æœåŠ¡æ­£å¸¸ - ${data.status}`);
                log('åç«¯æœåŠ¡æ£€æŸ¥æˆåŠŸ', 'success');
            } catch (error) {
                updateStatus('backend-status', false, 'åç«¯æœåŠ¡ç¦»çº¿');
                log(`åç«¯æœåŠ¡æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function checkFrontendStatus() {
            try {
                const response = await fetch('http://localhost:3000');
                if (response.ok) {
                    updateStatus('frontend-status', true, 'å‰ç«¯æœåŠ¡æ­£å¸¸');
                    log('å‰ç«¯æœåŠ¡æ£€æŸ¥æˆåŠŸ', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateStatus('frontend-status', false, 'å‰ç«¯æœåŠ¡ç¦»çº¿');
                log(`å‰ç«¯æœåŠ¡æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function checkAdminStatus() {
            try {
                const response = await fetch('http://localhost:3001');
                if (response.ok) {
                    updateStatus('admin-status', true, 'ç®¡ç†åå°æ­£å¸¸');
                    log('ç®¡ç†åå°æ£€æŸ¥æˆåŠŸ', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateStatus('admin-status', false, 'ç®¡ç†åå°ç¦»çº¿');
                log(`ç®¡ç†åå°æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function updateStatus(elementId, isOnline, message) {
            const element = document.getElementById(elementId);
            const indicator = element.querySelector('.status-indicator');
            const text = element.querySelector('span:last-child');
            
            indicator.className = `status-indicator ${isOnline ? 'status-online' : 'status-offline'}`;
            text.textContent = message;
        }

        // åº—é“ºç®¡ç†
        async function loadStores() {
            try {
                const response = await fetch('http://localhost:3002/api/stores');
                const data = await response.json();
                testData.stores = data.data || [];
                
                document.getElementById('stores-data').textContent = JSON.stringify(testData.stores, null, 2);
                
                // æ›´æ–°åº—é“ºé€‰æ‹©å™¨
                const selector = document.getElementById('store-selector');
                selector.innerHTML = '<option value="">é€‰æ‹©åº—é“º...</option>';
                testData.stores.forEach(store => {
                    const option = document.createElement('option');
                    option.value = store.id;
                    option.textContent = `${store.name} (${store.marketplace})`;
                    selector.appendChild(option);
                });
                
                log(`åŠ è½½äº† ${testData.stores.length} ä¸ªåº—é“º`, 'success');
            } catch (error) {
                log(`åŠ è½½åº—é“ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function createTestStore() {
            try {
                const testStore = {
                    name: `æµ‹è¯•åº—é“º_${Date.now()}`,
                    marketplace: 'United States',
                    currency_symbol: '$',
                    country: 'United States',
                    business_type: 'Business'
                };
                
                const response = await fetch('http://localhost:3002/api/stores', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testStore)
                });
                
                const data = await response.json();
                if (data.success) {
                    log(`åˆ›å»ºæµ‹è¯•åº—é“ºæˆåŠŸ: ${data.data.name}`, 'success');
                    await loadStores(); // é‡æ–°åŠ è½½åº—é“ºåˆ—è¡¨
                } else {
                    throw new Error(data.message || 'åˆ›å»ºå¤±è´¥');
                }
            } catch (error) {
                log(`åˆ›å»ºæµ‹è¯•åº—é“ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        function switchStore() {
            const selector = document.getElementById('store-selector');
            currentStoreId = selector.value;
            
            if (currentStoreId) {
                const store = testData.stores.find(s => s.id === currentStoreId);
                document.getElementById('current-store-data').textContent = JSON.stringify(store, null, 2);
                log(`åˆ‡æ¢åˆ°åº—é“º: ${store.name}`, 'info');
            } else {
                document.getElementById('current-store-data').textContent = 'è¯·é€‰æ‹©åº—é“º';
                log('å–æ¶ˆåº—é“ºé€‰æ‹©', 'info');
            }
        }

        // æ•°æ®åŒæ­¥æµ‹è¯•
        async function loadDashboardData() {
            if (!currentStoreId) {
                log('è¯·å…ˆé€‰æ‹©åº—é“º', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:3002/api/dashboard/snapshot/${currentStoreId}`);
                const data = await response.json();
                testData.dashboard = data.data;
                
                document.getElementById('dashboard-data').textContent = JSON.stringify(testData.dashboard, null, 2);
                log('Dashboardæ•°æ®åŠ è½½æˆåŠŸ', 'success');
            } catch (error) {
                log(`Dashboardæ•°æ®åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function updateDashboardData() {
            if (!currentStoreId) {
                log('è¯·å…ˆé€‰æ‹©åº—é“º', 'warning');
                return;
            }
            
            try {
                const updateData = {
                    sales_amount: Math.round(Math.random() * 1000),
                    open_orders: Math.round(Math.random() * 50),
                    buyer_messages: Math.round(Math.random() * 10)
                };
                
                const response = await fetch(`http://localhost:3002/api/dashboard/snapshot/${currentStoreId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                const data = await response.json();
                if (data.success) {
                    testData.dashboard = data.data;
                    document.getElementById('dashboard-data').textContent = JSON.stringify(testData.dashboard, null, 2);
                    log('Dashboardæ•°æ®æ›´æ–°æˆåŠŸ', 'success');
                } else {
                    throw new Error(data.message || 'æ›´æ–°å¤±è´¥');
                }
            } catch (error) {
                log(`Dashboardæ•°æ®æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function loadProductsData() {
            if (!currentStoreId) {
                log('è¯·å…ˆé€‰æ‹©åº—é“º', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:3002/api/products?store_id=${currentStoreId}&limit=5`);
                const data = await response.json();
                testData.products = data.data || [];
                
                document.getElementById('products-data').textContent = JSON.stringify(testData.products, null, 2);
                log(`åŠ è½½äº† ${testData.products.length} ä¸ªäº§å“`, 'success');
            } catch (error) {
                log(`äº§å“æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function createTestProduct() {
            if (!currentStoreId) {
                log('è¯·å…ˆé€‰æ‹©åº—é“º', 'warning');
                return;
            }
            
            try {
                const testProduct = {
                    store_id: currentStoreId,
                    title: `æµ‹è¯•äº§å“_${Date.now()}`,
                    sku: `TEST-SKU-${Date.now()}`,
                    asin: `B0${Math.random().toString(36).substr(2, 8).toUpperCase()}`,
                    price: Math.round(Math.random() * 100 * 100) / 100,
                    inventory: Math.round(Math.random() * 100),
                    status: 'Active'
                };
                
                const response = await fetch('http://localhost:3002/api/products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testProduct)
                });
                
                const data = await response.json();
                if (data.success) {
                    log(`åˆ›å»ºæµ‹è¯•äº§å“æˆåŠŸ: ${data.data.title}`, 'success');
                    await loadProductsData(); // é‡æ–°åŠ è½½äº§å“åˆ—è¡¨
                } else {
                    throw new Error(data.message || 'åˆ›å»ºå¤±è´¥');
                }
            } catch (error) {
                log(`åˆ›å»ºæµ‹è¯•äº§å“å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function updateTestProduct() {
            if (!currentStoreId || testData.products.length === 0) {
                log('è¯·å…ˆé€‰æ‹©åº—é“ºå¹¶åŠ è½½äº§å“æ•°æ®', 'warning');
                return;
            }
            
            try {
                const product = testData.products[0]; // æ›´æ–°ç¬¬ä¸€ä¸ªäº§å“
                const updateData = {
                    price: Math.round(Math.random() * 100 * 100) / 100,
                    inventory: Math.round(Math.random() * 100),
                    sales_amount: Math.round(Math.random() * 500 * 100) / 100
                };
                
                const response = await fetch(`http://localhost:3002/api/products/${product.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                const data = await response.json();
                if (data.success) {
                    log(`äº§å“æ›´æ–°æˆåŠŸ: ${product.title}`, 'success');
                    await loadProductsData(); // é‡æ–°åŠ è½½äº§å“åˆ—è¡¨
                } else {
                    throw new Error(data.message || 'æ›´æ–°å¤±è´¥');
                }
            } catch (error) {
                log(`äº§å“æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function loadSalesData() {
            if (!currentStoreId) {
                log('è¯·å…ˆé€‰æ‹©åº—é“º', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:3002/api/sales/snapshot/${currentStoreId}`);
                const data = await response.json();
                testData.sales = data.data;
                
                document.getElementById('sales-data').textContent = JSON.stringify(testData.sales, null, 2);
                log('é”€å”®æ•°æ®åŠ è½½æˆåŠŸ', 'success');
            } catch (error) {
                log(`é”€å”®æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function updateSalesData() {
            if (!currentStoreId) {
                log('è¯·å…ˆé€‰æ‹©åº—é“º', 'warning');
                return;
            }
            
            try {
                const updateData = {
                    total_order_items: Math.round(Math.random() * 500),
                    units_ordered: Math.round(Math.random() * 10000),
                    ordered_product_sales: Math.round(Math.random() * 50000 * 100) / 100
                };
                
                const response = await fetch(`http://localhost:3002/api/sales/snapshot/${currentStoreId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                const data = await response.json();
                if (data.success) {
                    testData.sales = data.data;
                    document.getElementById('sales-data').textContent = JSON.stringify(testData.sales, null, 2);
                    log('é”€å”®æ•°æ®æ›´æ–°æˆåŠŸ', 'success');
                } else {
                    throw new Error(data.message || 'æ›´æ–°å¤±è´¥');
                }
            } catch (error) {
                log(`é”€å”®æ•°æ®æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ç•Œé¢åˆ·æ–°
        function refreshFrontend() {
            const iframe = document.querySelector('iframe[src="http://localhost:3000"]');
            iframe.src = iframe.src;
            log('å‰ç«¯ç•Œé¢å·²åˆ·æ–°', 'info');
        }

        function refreshAdmin() {
            const iframe = document.querySelector('iframe[src="http://localhost:3001"]');
            iframe.src = iframe.src;
            log('ç®¡ç†åå°ç•Œé¢å·²åˆ·æ–°', 'info');
        }

        // å®Œæ•´æµ‹è¯•
        async function runFullTest() {
            log('å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•...', 'info');
            
            // 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
            await checkBackendStatus();
            await checkFrontendStatus();
            await checkAdminStatus();
            
            // 2. åŠ è½½åº—é“ºæ•°æ®
            await loadStores();
            
            // 3. å¦‚æœæœ‰åº—é“ºï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªè¿›è¡Œæµ‹è¯•
            if (testData.stores.length > 0) {
                const selector = document.getElementById('store-selector');
                selector.value = testData.stores[0].id;
                switchStore();
                
                // 4. æµ‹è¯•æ•°æ®åŠ è½½
                await loadDashboardData();
                await loadProductsData();
                await loadSalesData();
                
                // 5. æµ‹è¯•æ•°æ®æ›´æ–°
                await updateDashboardData();
                if (testData.products.length > 0) {
                    await updateTestProduct();
                }
                await updateSalesData();
                
                log('å®Œæ•´æµ‹è¯•å®Œæˆï¼', 'success');
            } else {
                log('æ²¡æœ‰æ‰¾åˆ°åº—é“ºï¼Œåˆ›å»ºæµ‹è¯•åº—é“º...', 'warning');
                await createTestStore();
                log('è¯·æ‰‹åŠ¨é€‰æ‹©åº—é“ºç»§ç»­æµ‹è¯•', 'info');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–æ£€æŸ¥...', 'info');
            checkBackendStatus();
            checkFrontendStatus();
            checkAdminStatus();
            loadStores();
        };
    </script>
</body>
</html>