<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•ç®¡ç†åå°åº—é“ºç®¡ç†åŠŸèƒ½</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #1890ff;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        .error {
            background-color: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }
        .info {
            background-color: #e6f7ff;
            border: 1px solid #91d5ff;
            color: #1890ff;
        }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #40a9ff;
        }
        .store-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .store-card {
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            padding: 15px;
            background: #fafafa;
        }
        .store-card.active {
            border-color: #1890ff;
            background: #e6f7ff;
        }
        .store-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
        }
        .store-details {
            font-size: 14px;
            color: #666;
        }
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-active {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }
        .status-inactive {
            background: #fff2f0;
            color: #ff4d4f;
            border: 1px solid #ffccc7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸª ç®¡ç†åå°åº—é“ºç®¡ç†åŠŸèƒ½æµ‹è¯•</h1>
        <p>æµ‹è¯•Amazon Seller Centralæ•°æ®ç®¡ç†åå°çš„åº—é“ºé€‰æ‹©å’Œæ•°æ®éš”ç¦»åŠŸèƒ½</p>

        <div class="test-section">
            <h3>1. åç«¯APIæœåŠ¡çŠ¶æ€æ£€æŸ¥</h3>
            <button onclick="checkBackendStatus()">æ£€æŸ¥åç«¯æœåŠ¡</button>
            <button onclick="checkAdminStatus()">æ£€æŸ¥ç®¡ç†åå°</button>
            <div id="service-status"></div>
        </div>

        <div class="test-section">
            <h3>2. åº—é“ºæ•°æ®åŠ è½½æµ‹è¯•</h3>
            <button onclick="loadStores()">åŠ è½½åº—é“ºåˆ—è¡¨</button>
            <div id="stores-result"></div>
            <div id="stores-list" class="store-list"></div>
        </div>

        <div class="test-section">
            <h3>3. åº—é“ºæ•°æ®éš”ç¦»æµ‹è¯•</h3>
            <button onclick="testStoreIsolation()">æµ‹è¯•æ•°æ®éš”ç¦»</button>
            <div id="isolation-result"></div>
        </div>

        <div class="test-section">
            <h3>4. äº§å“ç®¡ç†æµ‹è¯•</h3>
            <button onclick="testProductManagement()">æµ‹è¯•äº§å“ç®¡ç†</button>
            <div id="product-result"></div>
        </div>

        <div class="test-section">
            <h3>5. é”€å”®æ•°æ®é…ç½®æµ‹è¯•</h3>
            <button onclick="testSalesConfig()">æµ‹è¯•é”€å”®é…ç½®</button>
            <div id="sales-result"></div>
        </div>

        <div class="test-section">
            <h3>6. Dashboardé…ç½®æµ‹è¯•</h3>
            <button onclick="testDashboardConfig()">æµ‹è¯•Dashboardé…ç½®</button>
            <div id="dashboard-result"></div>
        </div>

        <div class="test-section">
            <h3>7. å‰ç«¯åŒæ­¥æµ‹è¯•</h3>
            <button onclick="testFrontendSync()">æµ‹è¯•å‰ç«¯æ•°æ®åŒæ­¥</button>
            <div id="sync-result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3002/api';
        const ADMIN_BASE = 'http://localhost:3001';
        const FRONTEND_BASE = 'http://localhost:3000';

        let currentStores = [];

        // æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€
        async function checkBackendStatus() {
            const statusDiv = document.getElementById('service-status');
            statusDiv.innerHTML = '<div class="info">æ­£åœ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€...</div>';

            try {
                // æ£€æŸ¥åç«¯API
                const backendResponse = await fetch(`${API_BASE}/stores`);
                const backendStatus = backendResponse.ok ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸';

                // æ£€æŸ¥ç®¡ç†åå°
                const adminResponse = await fetch(ADMIN_BASE);
                const adminStatus = adminResponse.ok ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸';

                // æ£€æŸ¥å‰ç«¯
                const frontendResponse = await fetch(FRONTEND_BASE);
                const frontendStatus = frontendResponse.ok ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸';

                statusDiv.innerHTML = `
                    <div class="success">
                        <strong>æœåŠ¡çŠ¶æ€æ£€æŸ¥å®Œæˆ:</strong><br>
                        â€¢ åç«¯API (3002): ${backendStatus}<br>
                        â€¢ ç®¡ç†åå° (3001): ${adminStatus}<br>
                        â€¢ å‰ç«¯ (3000): ${frontendStatus}
                    </div>
                `;
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">æœåŠ¡æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½åº—é“ºåˆ—è¡¨
        async function loadStores() {
            const resultDiv = document.getElementById('stores-result');
            const listDiv = document.getElementById('stores-list');
            
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨åŠ è½½åº—é“ºåˆ—è¡¨...</div>';

            try {
                const response = await fetch(`${API_BASE}/stores`);
                const data = await response.json();

                if (data.success) {
                    currentStores = data.data;
                    resultDiv.innerHTML = `<div class="success">æˆåŠŸåŠ è½½ ${currentStores.length} ä¸ªåº—é“º</div>`;
                    
                    // æ˜¾ç¤ºåº—é“ºåˆ—è¡¨
                    listDiv.innerHTML = currentStores.map(store => `
                        <div class="store-card ${store.is_active ? 'active' : ''}">
                            <div class="store-name">${store.name}</div>
                            <div class="store-details">
                                å¸‚åœº: ${store.marketplace}<br>
                                è´§å¸: ${store.currency_symbol}<br>
                                æ—¶åŒº: ${store.timezone}<br>
                                çŠ¶æ€: <span class="status-badge ${store.is_active ? 'status-active' : 'status-inactive'}">
                                    ${store.is_active ? 'æ¿€æ´»' : 'æœªæ¿€æ´»'}
                                </span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    resultDiv.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${data.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•åº—é“ºæ•°æ®éš”ç¦»
        async function testStoreIsolation() {
            const resultDiv = document.getElementById('isolation-result');
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•æ•°æ®éš”ç¦»...</div>';

            if (currentStores.length < 2) {
                resultDiv.innerHTML = '<div class="error">éœ€è¦è‡³å°‘2ä¸ªåº—é“ºæ¥æµ‹è¯•æ•°æ®éš”ç¦»</div>';
                return;
            }

            try {
                const store1 = currentStores[0];
                const store2 = currentStores[1];

                // è·å–ä¸¤ä¸ªåº—é“ºçš„äº§å“æ•°æ®
                const products1Response = await fetch(`${API_BASE}/products?store_id=${store1.id}`);
                const products1Data = await products1Response.json();

                const products2Response = await fetch(`${API_BASE}/products?store_id=${store2.id}`);
                const products2Data = await products2Response.json();

                let isolationResults = [];

                // æ£€æŸ¥æ•°æ®éš”ç¦»
                if (products1Data.success && products2Data.success) {
                    const products1 = products1Data.data || [];
                    const products2 = products2Data.data || [];

                    isolationResults.push(`åº—é“º "${store1.name}" æœ‰ ${products1.length} ä¸ªäº§å“`);
                    isolationResults.push(`åº—é“º "${store2.name}" æœ‰ ${products2.length} ä¸ªäº§å“`);

                    // æ£€æŸ¥æ˜¯å¦æœ‰äº¤å‰æ•°æ®
                    const crossContamination = products1.some(p1 => 
                        products2.some(p2 => p1.id === p2.id)
                    );

                    if (crossContamination) {
                        isolationResults.push('âŒ å‘ç°æ•°æ®äº¤å‰æ±¡æŸ“');
                    } else {
                        isolationResults.push('âœ… æ•°æ®éš”ç¦»æ­£å¸¸');
                    }
                }

                resultDiv.innerHTML = `
                    <div class="success">
                        <strong>æ•°æ®éš”ç¦»æµ‹è¯•ç»“æœ:</strong><br>
                        ${isolationResults.join('<br>')}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•äº§å“ç®¡ç†
        async function testProductManagement() {
            const resultDiv = document.getElementById('product-result');
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•äº§å“ç®¡ç†...</div>';

            if (currentStores.length === 0) {
                resultDiv.innerHTML = '<div class="error">è¯·å…ˆåŠ è½½åº—é“ºåˆ—è¡¨</div>';
                return;
            }

            try {
                const testStore = currentStores[0];
                const testResults = [];

                // æµ‹è¯•è·å–äº§å“åˆ—è¡¨
                const productsResponse = await fetch(`${API_BASE}/products?store_id=${testStore.id}`);
                const productsData = await productsResponse.json();

                if (productsData.success) {
                    testResults.push(`âœ… æˆåŠŸè·å–åº—é“º "${testStore.name}" çš„äº§å“åˆ—è¡¨ (${productsData.data?.length || 0} ä¸ªäº§å“)`);
                } else {
                    testResults.push(`âŒ è·å–äº§å“åˆ—è¡¨å¤±è´¥: ${productsData.message}`);
                }

                // æµ‹è¯•åˆ›å»ºäº§å“
                const newProduct = {
                    store_id: testStore.id,
                    title: `æµ‹è¯•äº§å“ ${Date.now()}`,
                    sku: `TEST-SKU-${Date.now()}`,
                    asin: `B${Date.now().toString().slice(-9)}`,
                    price: 29.99,
                    inventory: 100,
                    status: 'Active'
                };

                const createResponse = await fetch(`${API_BASE}/products`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newProduct)
                });

                const createData = await createResponse.json();
                if (createData.success) {
                    testResults.push(`âœ… æˆåŠŸåˆ›å»ºæµ‹è¯•äº§å“: ${newProduct.title}`);
                } else {
                    testResults.push(`âŒ åˆ›å»ºäº§å“å¤±è´¥: ${createData.message}`);
                }

                resultDiv.innerHTML = `
                    <div class="success">
                        <strong>äº§å“ç®¡ç†æµ‹è¯•ç»“æœ:</strong><br>
                        ${testResults.join('<br>')}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•é”€å”®é…ç½®
        async function testSalesConfig() {
            const resultDiv = document.getElementById('sales-result');
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•é”€å”®é…ç½®...</div>';

            if (currentStores.length === 0) {
                resultDiv.innerHTML = '<div class="error">è¯·å…ˆåŠ è½½åº—é“ºåˆ—è¡¨</div>';
                return;
            }

            try {
                const testStore = currentStores[0];
                const testResults = [];

                // æµ‹è¯•è·å–é”€å”®å¿«ç…§
                const snapshotResponse = await fetch(`${API_BASE}/sales/snapshot/${testStore.id}`);
                const snapshotData = await snapshotResponse.json();

                if (snapshotData.success) {
                    testResults.push(`âœ… æˆåŠŸè·å–åº—é“º "${testStore.name}" çš„é”€å”®å¿«ç…§`);
                } else {
                    testResults.push(`âŒ è·å–é”€å”®å¿«ç…§å¤±è´¥: ${snapshotData.message}`);
                }

                // æµ‹è¯•æ›´æ–°é”€å”®å¿«ç…§
                const updateData = {
                    total_order_items: 1000,
                    units_ordered: 1500,
                    ordered_product_sales: 25000.50,
                    avg_units_per_order: 1.5,
                    avg_sales_per_order: 25.00
                };

                const updateResponse = await fetch(`${API_BASE}/sales/snapshot/${testStore.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                const updateResult = await updateResponse.json();
                if (updateResult.success) {
                    testResults.push(`âœ… æˆåŠŸæ›´æ–°é”€å”®å¿«ç…§æ•°æ®`);
                } else {
                    testResults.push(`âŒ æ›´æ–°é”€å”®å¿«ç…§å¤±è´¥: ${updateResult.message}`);
                }

                resultDiv.innerHTML = `
                    <div class="success">
                        <strong>é”€å”®é…ç½®æµ‹è¯•ç»“æœ:</strong><br>
                        ${testResults.join('<br>')}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•Dashboardé…ç½®
        async function testDashboardConfig() {
            const resultDiv = document.getElementById('dashboard-result');
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•Dashboardé…ç½®...</div>';

            if (currentStores.length === 0) {
                resultDiv.innerHTML = '<div class="error">è¯·å…ˆåŠ è½½åº—é“ºåˆ—è¡¨</div>';
                return;
            }

            try {
                const testStore = currentStores[0];
                const testResults = [];

                // æµ‹è¯•è·å–Dashboardé…ç½®
                const configResponse = await fetch(`${API_BASE}/dashboard/config/${testStore.id}`);
                const configData = await configResponse.json();

                if (configData.success) {
                    testResults.push(`âœ… æˆåŠŸè·å–åº—é“º "${testStore.name}" çš„Dashboardé…ç½®`);
                } else {
                    testResults.push(`âŒ è·å–Dashboardé…ç½®å¤±è´¥: ${configData.message}`);
                }

                // æµ‹è¯•æ›´æ–°Dashboardé…ç½®
                const updateConfig = {
                    globalSnapshot: {
                        sales: { todaySoFar: 199.99, currency: testStore.currency_symbol },
                        orders: { totalCount: 10, fbmUnshipped: 1, fbmPending: 2, fbaPending: 7 },
                        messages: { casesRequiringAttention: 1 },
                        featuredOffer: { percentage: 95, daysAgo: 1 },
                        feedback: { rating: 4.8, count: 25 },
                        payments: { totalBalance: 1500.75, currency: testStore.currency_symbol }
                    }
                };

                const updateResponse = await fetch(`${API_BASE}/dashboard/config/${testStore.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateConfig)
                });

                const updateResult = await updateResponse.json();
                if (updateResult.success) {
                    testResults.push(`âœ… æˆåŠŸæ›´æ–°Dashboardé…ç½®`);
                } else {
                    testResults.push(`âŒ æ›´æ–°Dashboardé…ç½®å¤±è´¥: ${updateResult.message}`);
                }

                resultDiv.innerHTML = `
                    <div class="success">
                        <strong>Dashboardé…ç½®æµ‹è¯•ç»“æœ:</strong><br>
                        ${testResults.join('<br>')}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•å‰ç«¯åŒæ­¥
        async function testFrontendSync() {
            const resultDiv = document.getElementById('sync-result');
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•å‰ç«¯æ•°æ®åŒæ­¥...</div>';

            try {
                const testResults = [];

                // æ£€æŸ¥å‰ç«¯æ˜¯å¦èƒ½è®¿é—®
                const frontendResponse = await fetch(FRONTEND_BASE);
                if (frontendResponse.ok) {
                    testResults.push('âœ… å‰ç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ');
                } else {
                    testResults.push('âŒ å‰ç«¯æœåŠ¡æ— æ³•è®¿é—®');
                }

                // æ£€æŸ¥ç®¡ç†åå°æ˜¯å¦èƒ½è®¿é—®
                const adminResponse = await fetch(ADMIN_BASE);
                if (adminResponse.ok) {
                    testResults.push('âœ… ç®¡ç†åå°æœåŠ¡æ­£å¸¸è¿è¡Œ');
                } else {
                    testResults.push('âŒ ç®¡ç†åå°æœåŠ¡æ— æ³•è®¿é—®');
                }

                testResults.push('');
                testResults.push('ğŸ“‹ æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤:');
                testResults.push('1. æ‰“å¼€ç®¡ç†åå° (http://localhost:3001)');
                testResults.push('2. ç™»å½• (ç”¨æˆ·å: admin, å¯†ç : admin123)');
                testResults.push('3. åœ¨é¡¶éƒ¨é€‰æ‹©ä¸åŒçš„åº—é“º');
                testResults.push('4. ä¿®æ”¹äº§å“æˆ–é”€å”®æ•°æ®');
                testResults.push('5. æ‰“å¼€å‰ç«¯ (http://localhost:3000)');
                testResults.push('6. éªŒè¯æ•°æ®æ˜¯å¦åŒæ­¥æ›´æ–°');

                resultDiv.innerHTML = `
                    <div class="info">
                        <strong>å‰ç«¯åŒæ­¥æµ‹è¯•ç»“æœ:</strong><br>
                        ${testResults.join('<br>')}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€
        window.onload = function() {
            checkBackendStatus();
            setTimeout(loadStores, 1000);
        };
    </script>
</body>
</html>