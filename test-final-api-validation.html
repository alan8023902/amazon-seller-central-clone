<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€ç»ˆAPIéªŒè¯æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid;
        }
        .success { background-color: #d4edda; border-color: #28a745; }
        .error { background-color: #f8d7da; border-color: #dc3545; }
        .info { background-color: #d1ecf1; border-color: #17a2b8; }
        .warning { background-color: #fff3cd; border-color: #ffc107; }
        
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        
        .service-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .status-online { background-color: #d4edda; }
        .status-offline { background-color: #f8d7da; }
        
        .data-sample {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 5px 0;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ æœ€ç»ˆAPIéªŒè¯æµ‹è¯•</h1>
        <p>éªŒè¯æ‰€æœ‰APIç«¯ç‚¹å’Œç»Ÿä¸€é…ç½®æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
        
        <button onclick="runCompleteTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
        <button onclick="testPortConfiguration()">æµ‹è¯•ç«¯å£é…ç½®</button>
        <button onclick="testUnifiedConfig()">æµ‹è¯•ç»Ÿä¸€é…ç½®</button>
        <button onclick="testDataIntegrity()">æµ‹è¯•æ•°æ®å®Œæ•´æ€§</button>
        
        <div id="testResults"></div>
    </div>

    <script>
        // ç»Ÿä¸€é…ç½® - åº”è¯¥ä¸ä»£ç ä¸­çš„é…ç½®ä¸€è‡´
        const CONFIG = {
            BACKEND_BASE: 'http://localhost:3001',
            FRONTEND_URL: 'http://localhost:3000',
            ADMIN_URL: 'http://localhost:3002'
        };

        // æµ‹è¯•ç«¯ç‚¹é…ç½®
        const TEST_ENDPOINTS = [
            {
                name: 'å¥åº·æ£€æŸ¥',
                url: `${CONFIG.BACKEND_BASE}/api/health`,
                method: 'GET',
                expectedFields: ['status', 'timestamp', 'version']
            },
            {
                name: 'åº—é“ºåˆ—è¡¨',
                url: `${CONFIG.BACKEND_BASE}/api/stores`,
                method: 'GET',
                expectedFields: ['success', 'data'],
                dataValidation: (data) => Array.isArray(data.data) && data.data.length > 0
            },
            {
                name: 'Dashboardå¿«ç…§ (ç¾å›½åº—)',
                url: `${CONFIG.BACKEND_BASE}/api/dashboard/snapshot/store-us-main`,
                method: 'GET',
                expectedFields: ['success', 'data'],
                dataValidation: (data) => data.data && typeof data.data === 'object'
            },
            {
                name: 'Communicationsæ•°æ® (ç¾å›½åº—)',
                url: `${CONFIG.BACKEND_BASE}/api/communications/store-us-main`,
                method: 'GET',
                expectedFields: ['success', 'data'],
                dataValidation: (data) => data.data && (data.data.forums || data.data.news)
            },
            {
                name: 'äº§å“åˆ—è¡¨ (ç¾å›½åº—)',
                url: `${CONFIG.BACKEND_BASE}/api/products?store_id=store-us-main&limit=5`,
                method: 'GET',
                expectedFields: ['success', 'data'],
                dataValidation: (data) => Array.isArray(data.data)
            },
            {
                name: 'ç”¨æˆ·åˆ—è¡¨',
                url: `${CONFIG.BACKEND_BASE}/api/users`,
                method: 'GET',
                expectedFields: ['success', 'data'],
                dataValidation: (data) => Array.isArray(data.data) && data.data.length > 0
            },
            {
                name: 'VOCæ•°æ® (ç¾å›½åº—)',
                url: `${CONFIG.BACKEND_BASE}/api/voc/store-us-main`,
                method: 'GET',
                expectedFields: ['success', 'data'],
                dataValidation: (data) => data.data && typeof data.data === 'object'
            }
        ];

        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('testResults');
            const logEntry = document.createElement('div');
            logEntry.className = `test-result ${type}`;
            logEntry.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            resultsDiv.appendChild(logEntry);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function showDataSample(data, title) {
            const sampleDiv = document.createElement('div');
            sampleDiv.className = 'data-sample';
            sampleDiv.innerHTML = `<strong>${title}:</strong><br>${JSON.stringify(data, null, 2)}`;
            document.getElementById('testResults').appendChild(sampleDiv);
        }

        async function testPortConfiguration() {
            log('ğŸ” æµ‹è¯•ç«¯å£é…ç½®...', 'info');
            
            const services = [
                { name: 'å‰ç«¯åº”ç”¨', url: CONFIG.FRONTEND_URL, expectedPort: 3000 },
                { name: 'ç®¡ç†åå°', url: CONFIG.ADMIN_URL, expectedPort: 3002 },
                { name: 'åç«¯API', url: CONFIG.BACKEND_BASE, expectedPort: 3001 }
            ];

            for (const service of services) {
                try {
                    const response = await fetch(service.url, { 
                        method: 'GET',
                        mode: 'no-cors'
                    });
                    log(`âœ… ${service.name} (ç«¯å£ ${service.expectedPort}): æœåŠ¡å¯è®¿é—®`, 'success');
                } catch (error) {
                    log(`âŒ ${service.name} (ç«¯å£ ${service.expectedPort}): æœåŠ¡ä¸å¯è®¿é—® - ${error.message}`, 'error');
                }
            }
        }

        async function testUnifiedConfig() {
            log('âš™ï¸ æµ‹è¯•ç»Ÿä¸€é…ç½®...', 'info');
            
            // éªŒè¯é…ç½®ä¸€è‡´æ€§
            const expectedBackendUrl = 'http://localhost:3001';
            const expectedFrontendPort = 3000;
            const expectedAdminPort = 3002;
            const expectedBackendPort = 3001;
            
            if (CONFIG.BACKEND_BASE === expectedBackendUrl) {
                log(`âœ… åç«¯APIé…ç½®æ­£ç¡®: ${CONFIG.BACKEND_BASE}`, 'success');
            } else {
                log(`âŒ åç«¯APIé…ç½®é”™è¯¯: æœŸæœ› ${expectedBackendUrl}, å®é™… ${CONFIG.BACKEND_BASE}`, 'error');
            }
            
            if (CONFIG.FRONTEND_URL === `http://localhost:${expectedFrontendPort}`) {
                log(`âœ… å‰ç«¯é…ç½®æ­£ç¡®: ${CONFIG.FRONTEND_URL}`, 'success');
            } else {
                log(`âŒ å‰ç«¯é…ç½®é”™è¯¯`, 'error');
            }
            
            if (CONFIG.ADMIN_URL === `http://localhost:${expectedAdminPort}`) {
                log(`âœ… ç®¡ç†åå°é…ç½®æ­£ç¡®: ${CONFIG.ADMIN_URL}`, 'success');
            } else {
                log(`âŒ ç®¡ç†åå°é…ç½®é”™è¯¯`, 'error');
            }
        }

        async function testDataIntegrity() {
            log('ğŸ“Š æµ‹è¯•æ•°æ®å®Œæ•´æ€§...', 'info');
            
            try {
                // è·å–åº—é“ºæ•°æ®
                const storesResponse = await fetch(`${CONFIG.BACKEND_BASE}/api/stores`);
                const storesData = await storesResponse.json();
                
                if (storesData.success && storesData.data.length > 0) {
                    log(`âœ… åº—é“ºæ•°æ®å®Œæ•´: æ‰¾åˆ° ${storesData.data.length} ä¸ªåº—é“º`, 'success');
                    
                    // æ˜¾ç¤ºåº—é“ºæ•°æ®æ ·æœ¬
                    const storeSample = storesData.data.slice(0, 2).map(store => ({
                        id: store.id,
                        name: store.name,
                        marketplace: store.marketplace,
                        currency_symbol: store.currency_symbol
                    }));
                    showDataSample(storeSample, 'åº—é“ºæ•°æ®æ ·æœ¬');
                    
                    // æµ‹è¯•æ¯ä¸ªåº—é“ºçš„å…³è”æ•°æ®
                    for (const store of storesData.data.slice(0, 2)) {
                        log(`ğŸª éªŒè¯åº—é“ºæ•°æ®: ${store.name} (${store.marketplace})`, 'info');
                        
                        // æµ‹è¯•Dashboardæ•°æ®
                        try {
                            const dashboardResponse = await fetch(`${CONFIG.BACKEND_BASE}/api/dashboard/snapshot/${store.id}`);
                            const dashboardData = await dashboardResponse.json();
                            
                            if (dashboardData.success && dashboardData.data) {
                                log(`   âœ… Dashboardæ•°æ®å®Œæ•´`, 'success');
                                
                                // éªŒè¯å…³é”®å­—æ®µ
                                const snapshot = dashboardData.data;
                                const requiredFields = ['sales', 'orders', 'messages', 'featuredOffer', 'feedback', 'payments'];
                                const missingFields = requiredFields.filter(field => !snapshot[field]);
                                
                                if (missingFields.length === 0) {
                                    log(`   âœ… Dashboardæ‰€æœ‰å¿…éœ€å­—æ®µéƒ½å­˜åœ¨`, 'success');
                                } else {
                                    log(`   âš ï¸ Dashboardç¼ºå°‘å­—æ®µ: ${missingFields.join(', ')}`, 'warning');
                                }
                            } else {
                                log(`   âŒ Dashboardæ•°æ®å¼‚å¸¸`, 'error');
                            }
                        } catch (error) {
                            log(`   âŒ Dashboardæ•°æ®è·å–å¤±è´¥: ${error.message}`, 'error');
                        }
                        
                        // æµ‹è¯•äº§å“æ•°æ®
                        try {
                            const productsResponse = await fetch(`${CONFIG.BACKEND_BASE}/api/products?store_id=${store.id}&limit=3`);
                            const productsData = await productsResponse.json();
                            
                            if (productsData.success && Array.isArray(productsData.data)) {
                                log(`   âœ… äº§å“æ•°æ®å®Œæ•´: ${productsData.data.length} ä¸ªäº§å“`, 'success');
                                
                                if (productsData.data.length > 0) {
                                    const productSample = productsData.data[0];
                                    const productFields = ['id', 'title', 'sku', 'price', 'inventory', 'status'];
                                    const hasAllFields = productFields.every(field => productSample[field] !== undefined);
                                    
                                    if (hasAllFields) {
                                        log(`   âœ… äº§å“æ•°æ®ç»“æ„å®Œæ•´`, 'success');
                                    } else {
                                        log(`   âš ï¸ äº§å“æ•°æ®ç»“æ„ä¸å®Œæ•´`, 'warning');
                                    }
                                }
                            } else {
                                log(`   âŒ äº§å“æ•°æ®å¼‚å¸¸`, 'error');
                            }
                        } catch (error) {
                            log(`   âŒ äº§å“æ•°æ®è·å–å¤±è´¥: ${error.message}`, 'error');
                        }
                        
                        // æµ‹è¯•Communicationsæ•°æ®
                        try {
                            const commResponse = await fetch(`${CONFIG.BACKEND_BASE}/api/communications/${store.id}`);
                            const commData = await commResponse.json();
                            
                            if (commData.success && commData.data) {
                                const hasForums = commData.data.forums && Array.isArray(commData.data.forums);
                                const hasNews = commData.data.news && Array.isArray(commData.data.news);
                                
                                if (hasForums && hasNews) {
                                    log(`   âœ… Communicationsæ•°æ®å®Œæ•´: ${commData.data.forums.length} è®ºå›, ${commData.data.news.length} æ–°é—»`, 'success');
                                } else {
                                    log(`   âš ï¸ Communicationsæ•°æ®ä¸å®Œæ•´`, 'warning');
                                }
                            } else {
                                log(`   âŒ Communicationsæ•°æ®å¼‚å¸¸`, 'error');
                            }
                        } catch (error) {
                            log(`   âŒ Communicationsæ•°æ®è·å–å¤±è´¥: ${error.message}`, 'error');
                        }
                    }
                } else {
                    log(`âŒ åº—é“ºæ•°æ®ä¸å®Œæ•´æˆ–ä¸ºç©º`, 'error');
                }
            } catch (error) {
                log(`âŒ æ•°æ®å®Œæ•´æ€§æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testApiEndpoints() {
            log('ğŸŒ æµ‹è¯•APIç«¯ç‚¹...', 'info');
            
            for (const endpoint of TEST_ENDPOINTS) {
                try {
                    const response = await fetch(endpoint.url, {
                        method: endpoint.method,
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    // éªŒè¯å¿…éœ€å­—æ®µ
                    const missingFields = endpoint.expectedFields.filter(field => data[field] === undefined);
                    if (missingFields.length > 0) {
                        log(`âš ï¸ ${endpoint.name}: ç¼ºå°‘å­—æ®µ ${missingFields.join(', ')}`, 'warning');
                        continue;
                    }
                    
                    // éªŒè¯æ•°æ®
                    if (endpoint.dataValidation && !endpoint.dataValidation(data)) {
                        log(`âš ï¸ ${endpoint.name}: æ•°æ®éªŒè¯å¤±è´¥`, 'warning');
                        continue;
                    }
                    
                    log(`âœ… ${endpoint.name}: APIæ­£å¸¸`, 'success');
                    
                } catch (error) {
                    log(`âŒ ${endpoint.name}: ${error.message}`, 'error');
                }
            }
        }

        async function runCompleteTest() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '';
            
            log('ğŸš€ å¼€å§‹å®Œæ•´çš„APIéªŒè¯æµ‹è¯•...', 'info');
            
            await testPortConfiguration();
            await testUnifiedConfig();
            await testApiEndpoints();
            await testDataIntegrity();
            
            log('âœ¨ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼æ£€æŸ¥ä¸Šé¢çš„ç»“æœä»¥ç¡®è®¤ç³»ç»ŸçŠ¶æ€ã€‚', 'success');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.onload = function() {
            log('ğŸ“± é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹éªŒè¯...', 'info');
            setTimeout(runCompleteTest, 1000);
        };
    </script>
</body>
</html>