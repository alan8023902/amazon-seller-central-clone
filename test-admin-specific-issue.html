<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Specific Issue Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
        button { margin: 5px; padding: 10px; }
    </style>
</head>
<body>
    <h1>Admin Specific Issue Test</h1>
    
    <div class="test-section">
        <h2>1. Test Admin API Config</h2>
        <button onclick="testAdminAPIConfig()">Test Admin API Config</button>
        <div id="configResult"></div>
    </div>

    <div class="test-section">
        <h2>2. Test Store API from Admin Context</h2>
        <button onclick="testStoreAPIFromAdmin()">Test Store API</button>
        <div id="storeResult"></div>
    </div>

    <div class="test-section">
        <h2>3. Test Sales API (404 Error)</h2>
        <button onclick="testSalesAPI()">Test Sales API</button>
        <div id="salesResult"></div>
    </div>

    <div class="test-section">
        <h2>4. Test Network from Admin Port</h2>
        <button onclick="testNetworkFromAdmin()">Test Network</button>
        <div id="networkResult"></div>
    </div>

    <script>
        const ADMIN_API_CONFIG = {
            BASE_URL: 'http://localhost:3001',
            ENDPOINTS: {
                STORES: {
                    LIST: '/api/stores'
                },
                SALES: {
                    BY_STORE: (storeId) => `/api/sales?store_id=${storeId}`
                },
                DASHBOARD: {
                    SNAPSHOT: (storeId) => `/api/dashboard/snapshot/${storeId}`
                }
            }
        };

        async function testAdminAPIConfig() {
            const resultDiv = document.getElementById('configResult');
            resultDiv.innerHTML = `
                <div class="info">Admin API Configuration:</div>
                <pre>${JSON.stringify(ADMIN_API_CONFIG, null, 2)}</pre>
            `;
        }

        async function testStoreAPIFromAdmin() {
            const resultDiv = document.getElementById('storeResult');
            resultDiv.innerHTML = '<div class="info">Testing stores API from admin context...</div>';
            
            try {
                const url = `${ADMIN_API_CONFIG.BASE_URL}${ADMIN_API_CONFIG.ENDPOINTS.STORES.LIST}`;
                console.log('Requesting:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">✅ Stores API working from admin context</div>
                        <div class="info">URL: ${url}</div>
                        <div class="info">Status: ${response.status}</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">❌ Stores API failed: ${response.status}</div>
                        <div class="info">URL: ${url}</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">❌ Network error: ${error.message}</div>
                    <div class="info">This suggests a connection issue between admin (3002) and backend (3001)</div>
                `;
            }
        }

        async function testSalesAPI() {
            const resultDiv = document.getElementById('salesResult');
            resultDiv.innerHTML = '<div class="info">Testing sales API (the one causing 404)...</div>';
            
            const storeId = 'store-us-main'; // Use proper store ID
            
            try {
                const url = `${ADMIN_API_CONFIG.BASE_URL}${ADMIN_API_CONFIG.ENDPOINTS.SALES.BY_STORE(storeId)}`;
                console.log('Requesting:', url);
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">✅ Sales API working</div>
                        <div class="info">URL: ${url}</div>
                        <div class="info">Status: ${response.status}</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">❌ Sales API failed: ${response.status}</div>
                        <div class="info">URL: ${url}</div>
                        <div class="info">This might be why admin shows "API连接错误"</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">❌ Sales API error: ${error.message}</div>
                `;
            }
        }

        async function testNetworkFromAdmin() {
            const resultDiv = document.getElementById('networkResult');
            resultDiv.innerHTML = '<div class="info">Testing network connectivity...</div>';
            
            const tests = [
                { name: 'Backend Health', url: 'http://localhost:3001/api/health' },
                { name: 'Admin Interface', url: 'http://localhost:3002/' },
                { name: 'Cross-Origin Request', url: 'http://localhost:3001/api/stores' }
            ];
            
            const results = [];
            
            for (const test of tests) {
                try {
                    const response = await fetch(test.url);
                    
                    if (response.ok) {
                        results.push(`<div class="success">✅ ${test.name}: OK (${response.status})</div>`);
                    } else {
                        results.push(`<div class="error">❌ ${test.name}: Error ${response.status}</div>`);
                    }
                } catch (error) {
                    results.push(`<div class="error">❌ ${test.name}: ${error.message}</div>`);
                }
            }
            
            resultDiv.innerHTML = results.join('');
        }

        // Auto-run tests
        window.onload = function() {
            setTimeout(testAdminAPIConfig, 500);
            setTimeout(testStoreAPIFromAdmin, 1000);
            setTimeout(testSalesAPI, 1500);
            setTimeout(testNetworkFromAdmin, 2000);
        };
    </script>
</body>
</html>