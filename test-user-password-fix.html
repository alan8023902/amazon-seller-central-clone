<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·å¯†ç ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        
        .user-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        
        .credential {
            font-family: monospace;
            background-color: #e9ecef;
            padding: 4px 8px;
            border-radius: 3px;
            margin: 0 5px;
        }
        
        .copy-btn {
            background-color: #28a745;
            font-size: 12px;
            padding: 2px 6px;
        }
        
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ç”¨æˆ·å¯†ç ä¿®å¤æµ‹è¯•</h1>
        <p>æµ‹è¯•ç®¡ç†åå°ç”¨æˆ·å¯†ç åŠŸèƒ½å’Œå‰ç«¯ç™»å½•éªŒè¯</p>
        
        <div class="test-section info">
            <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
            <ul>
                <li><strong>å¯†ç æ ¼å¼</strong>: 1ä¸ªè‹±æ–‡å­—æ¯ + 6ä½æ•°å­— (å¦‚: A123456)</li>
                <li><strong>éªŒè¯ç æ ¼å¼</strong>: 6ä½æ•°å­— (å¦‚: 123456)</li>
                <li><strong>åŠŸèƒ½</strong>: å¯ä»¥åˆ†åˆ«åˆ·æ–°å¯†ç å’ŒéªŒè¯ç </li>
                <li><strong>å¤åˆ¶åŠŸèƒ½</strong>: ç‚¹å‡»å¯å¤åˆ¶å¯†ç å’ŒéªŒè¯ç </li>
            </ul>
        </div>

        <div class="test-section">
            <h3>ğŸ”§ æœåŠ¡çŠ¶æ€æ£€æŸ¥</h3>
            <button onclick="checkServices()">æ£€æŸ¥æ‰€æœ‰æœåŠ¡</button>
            <div id="serviceStatus"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ‘¥ ç”¨æˆ·åˆ—è¡¨æµ‹è¯•</h3>
            <button onclick="loadUsers()">åŠ è½½ç”¨æˆ·åˆ—è¡¨</button>
            <button onclick="testUserCreation()">æµ‹è¯•åˆ›å»ºæ–°ç”¨æˆ·</button>
            <div id="userList"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ”„ å¯†ç å’ŒéªŒè¯ç åˆ·æ–°æµ‹è¯•</h3>
            <p>é€‰æ‹©ä¸€ä¸ªç”¨æˆ·æµ‹è¯•åˆ·æ–°åŠŸèƒ½:</p>
            <div id="refreshTest"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ”‘ å‰ç«¯ç™»å½•æµ‹è¯•</h3>
            <p>ä½¿ç”¨ç”Ÿæˆçš„å¯†ç æµ‹è¯•å‰ç«¯ç™»å½•:</p>
            <div id="loginTest">
                <p>1. æ‰“å¼€å‰ç«¯: <a href="http://localhost:3000" target="_blank">http://localhost:3000</a></p>
                <p>2. ä½¿ç”¨ä¸‹é¢çš„å‡­æ®ç™»å½•:</p>
                <div id="loginCredentials"></div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æµ‹è¯•ç»“æœ</h3>
            <div id="testResults"></div>
        </div>
    </div>

    <script>
        let users = [];
        let testResults = [];

        async function checkServices() {
            const statusDiv = document.getElementById('serviceStatus');
            statusDiv.innerHTML = '<p>æ£€æŸ¥ä¸­...</p>';
            
            const services = [
                { name: 'å‰ç«¯', url: 'http://localhost:3000', port: 3000 },
                { name: 'åç«¯API', url: 'http://localhost:3001/api/health', port: 3001 },
                { name: 'ç®¡ç†åå°', url: 'http://localhost:3002', port: 3002 }
            ];
            
            let html = '<h4>æœåŠ¡çŠ¶æ€:</h4>';
            
            for (const service of services) {
                try {
                    const response = await fetch(service.url, { 
                        method: 'GET',
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        html += `<p>âœ… ${service.name} (ç«¯å£ ${service.port}): è¿è¡Œæ­£å¸¸</p>`;
                    } else {
                        html += `<p>âŒ ${service.name} (ç«¯å£ ${service.port}): HTTP ${response.status}</p>`;
                    }
                } catch (error) {
                    html += `<p>âŒ ${service.name} (ç«¯å£ ${service.port}): è¿æ¥å¤±è´¥</p>`;
                }
            }
            
            statusDiv.innerHTML = html;
        }

        async function loadUsers() {
            const userListDiv = document.getElementById('userList');
            userListDiv.innerHTML = '<p>åŠ è½½ä¸­...</p>';
            
            try {
                const response = await fetch('http://localhost:3001/api/users');
                const result = await response.json();
                
                if (result.success) {
                    users = result.data;
                    displayUsers(users);
                    updateLoginCredentials();
                    updateRefreshTest();
                    addTestResult('âœ… ç”¨æˆ·åˆ—è¡¨åŠ è½½æˆåŠŸ', 'success');
                } else {
                    userListDiv.innerHTML = `<p class="error">åŠ è½½å¤±è´¥: ${result.message}</p>`;
                    addTestResult('âŒ ç”¨æˆ·åˆ—è¡¨åŠ è½½å¤±è´¥', 'error');
                }
            } catch (error) {
                userListDiv.innerHTML = `<p class="error">è¯·æ±‚å¤±è´¥: ${error.message}</p>`;
                addTestResult('âŒ ç”¨æˆ·APIè¯·æ±‚å¤±è´¥', 'error');
            }
        }

        function displayUsers(users) {
            const userListDiv = document.getElementById('userList');
            
            if (users.length === 0) {
                userListDiv.innerHTML = '<p>æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·</p>';
                return;
            }
            
            let html = `<h4>æ‰¾åˆ° ${users.length} ä¸ªç”¨æˆ·:</h4>`;
            
            users.forEach(user => {
                html += `
                    <div class="user-card">
                        <h5>${user.name} (${user.email})</h5>
                        <p><strong>è§’è‰²:</strong> ${user.role}</p>
                        <p><strong>å¯†ç :</strong> 
                            <span class="credential">${user.password || 'æœªè®¾ç½®'}</span>
                            <button class="copy-btn" onclick="copyToClipboard('${user.password}')">å¤åˆ¶</button>
                        </p>
                        <p><strong>éªŒè¯ç :</strong> 
                            <span class="credential">${user.otp_secret}</span>
                            <button class="copy-btn" onclick="copyToClipboard('${user.otp_secret}')">å¤åˆ¶</button>
                        </p>
                        <p><strong>çŠ¶æ€:</strong> ${user.is_active ? 'å¯ç”¨' : 'ç¦ç”¨'}</p>
                        <p><strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(user.created_at).toLocaleString()}</p>
                    </div>
                `;
            });
            
            userListDiv.innerHTML = html;
        }

        function updateLoginCredentials() {
            const credentialsDiv = document.getElementById('loginCredentials');
            
            if (users.length === 0) {
                credentialsDiv.innerHTML = '<p>è¯·å…ˆåŠ è½½ç”¨æˆ·åˆ—è¡¨</p>';
                return;
            }
            
            let html = '<h4>å¯ç”¨ç™»å½•å‡­æ®:</h4>';
            
            users.forEach(user => {
                if (user.password) {
                    html += `
                        <div class="user-card">
                            <p><strong>é‚®ç®±:</strong> <span class="credential">${user.email}</span> 
                               <button class="copy-btn" onclick="copyToClipboard('${user.email}')">å¤åˆ¶</button></p>
                            <p><strong>å¯†ç :</strong> <span class="credential">${user.password}</span> 
                               <button class="copy-btn" onclick="copyToClipboard('${user.password}')">å¤åˆ¶</button></p>
                            <p><strong>éªŒè¯ç :</strong> <span class="credential">${user.otp_secret}</span> 
                               <button class="copy-btn" onclick="copyToClipboard('${user.otp_secret}')">å¤åˆ¶</button></p>
                        </div>
                    `;
                }
            });
            
            credentialsDiv.innerHTML = html;
        }

        function updateRefreshTest() {
            const refreshDiv = document.getElementById('refreshTest');
            
            if (users.length === 0) {
                refreshDiv.innerHTML = '<p>è¯·å…ˆåŠ è½½ç”¨æˆ·åˆ—è¡¨</p>';
                return;
            }
            
            let html = '';
            users.slice(0, 3).forEach(user => { // åªæ˜¾ç¤ºå‰3ä¸ªç”¨æˆ·
                html += `
                    <div class="user-card">
                        <h5>${user.name}</h5>
                        <p>å½“å‰å¯†ç : <span class="credential">${user.password || 'æœªè®¾ç½®'}</span></p>
                        <p>å½“å‰éªŒè¯ç : <span class="credential">${user.otp_secret}</span></p>
                        <button onclick="refreshPassword('${user.id}', '${user.name}')">åˆ·æ–°å¯†ç </button>
                        <button onclick="refreshOTP('${user.id}', '${user.name}')">åˆ·æ–°éªŒè¯ç </button>
                    </div>
                `;
            });
            
            refreshDiv.innerHTML = html;
        }

        async function refreshPassword(userId, userName) {
            try {
                const response = await fetch(`http://localhost:3001/api/users/${userId}/refresh-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addTestResult(`âœ… ${userName} çš„å¯†ç å·²åˆ·æ–°: ${result.data.password}`, 'success');
                    loadUsers(); // é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨
                } else {
                    addTestResult(`âŒ ${userName} å¯†ç åˆ·æ–°å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                addTestResult(`âŒ ${userName} å¯†ç åˆ·æ–°è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function refreshOTP(userId, userName) {
            try {
                const response = await fetch(`http://localhost:3001/api/users/${userId}/refresh-otp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addTestResult(`âœ… ${userName} çš„éªŒè¯ç å·²åˆ·æ–°: ${result.data.otp_secret}`, 'success');
                    loadUsers(); // é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨
                } else {
                    addTestResult(`âŒ ${userName} éªŒè¯ç åˆ·æ–°å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                addTestResult(`âŒ ${userName} éªŒè¯ç åˆ·æ–°è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testUserCreation() {
            const testUser = {
                name: 'æµ‹è¯•ç”¨æˆ·' + Date.now(),
                email: `test${Date.now()}@example.com`,
                role: 'user',
                is_active: true
            };
            
            try {
                const response = await fetch('http://localhost:3001/api/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testUser)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addTestResult(`âœ… æ–°ç”¨æˆ·åˆ›å»ºæˆåŠŸ: ${result.data.name}, å¯†ç : ${result.data.password}, éªŒè¯ç : ${result.data.otp_secret}`, 'success');
                    loadUsers(); // é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨
                } else {
                    addTestResult(`âŒ ç”¨æˆ·åˆ›å»ºå¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                addTestResult(`âŒ ç”¨æˆ·åˆ›å»ºè¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                addTestResult(`ğŸ“‹ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿: ${text}`, 'info');
            }).catch(err => {
                addTestResult(`âŒ å¤åˆ¶å¤±è´¥: ${err.message}`, 'error');
            });
        }

        function addTestResult(message, type) {
            testResults.push({ message, type, time: new Date().toLocaleTimeString() });
            updateTestResults();
        }

        function updateTestResults() {
            const resultsDiv = document.getElementById('testResults');
            
            let html = '<h4>æµ‹è¯•æ—¥å¿—:</h4>';
            testResults.slice(-10).forEach(result => {
                html += `<p class="${result.type}">[${result.time}] ${result.message}</p>`;
            });
            
            resultsDiv.innerHTML = html;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥æœåŠ¡
        window.onload = function() {
            checkServices();
            addTestResult('ğŸš€ æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
        };
    </script>
</body>
</html>